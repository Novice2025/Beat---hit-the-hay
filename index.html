<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">RealTalk Daby (Corporate Edition) - Daily Expression</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for dark mode and fonts */
        body {
            font-family: 'Verdana', 'Segoe UI', Tahoma, Geneva, sans-serif; /* Simula um estilo de escrita mais limpo */
            background-color: #030712; /* Deeper Dark background */
            color: #e5e7eb; /* Light text */
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .highlight {
            background-color: #4c1d95; /* Accent color (Dark Purple) */
            color: #fcd34d; /* Yellow text for highlights */
            padding: 0.2em 0.5em;
            border-radius: 0.3em;
            display: inline-block;
            font-weight: 600;
        }
        /* Animation for bullet points */
        ul.animated-bullets li::before {
            content: 'üí¨'; /* Chat/message icon */
            margin-right: 0.5em;
            animation: bounce 1s infinite alternate;
            color: #a78bfa; /* Light Purple color */
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-3px); }
        }
        .loader {
            border: 4px solid #3b82f6;
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .loader-lg { /* Loader para o dashboard */
            border: 6px solid #3b82f6;
            border-top: 6px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .option-button {
            transition: all 0.2s;
        }
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(76, 29, 149, 0.5);
        }
        .correct-answer {
            background-color: #15803d !important; /* Green 700 */
        }
        .incorrect-answer {
            background-color: #b91c1c !important; /* Red 700 */
        }

        /* --- NEW ANIMATION STYLES FOR GAMIFICATION --- */
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        /* Success/Confetti Simulation: A dramatic flash effect */
        .confetti-flash {
            animation: success-flash 0.4s ease-out;
            box-shadow: 0 0 15px 5px #fcd34d, 0 0 5px 2px #a78bfa;
        }
        @keyframes success-flash {
            0% { opacity: 0.5; transform: scale(1.0); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1.0); }
        }

        /* Dialogue Box Styling */
        .dialogue-box {
            background-color: #1f2937; /* Darker gray for the box */
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex; /* Para alinhar o texto e os bot√µes */
            align-items: center; /* Centraliza verticalmente */
        }
        .speaker-a {
            background-color: #312e81; /* Indigo 800 */
            color: #eef2ff;
            border-radius: 0.75rem 0.75rem 0.1rem 0.75rem;
        }
        .speaker-b {
            background-color: #8338ec; /* Custom Purple/Fuchsia */
            color: white;
            border-radius: 0.75rem 0.75rem 0.75rem 0.1rem;
        }
        /* Loader/Indicator for Dashboard */
        .progress-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        /* Custom styles for dropdowns in dark mode */
        select, option {
            background-color: #1f2937; /* Darker gray */
            color: #e5e7eb; /* Light text */
            border: 1px solid #4b5563; /* Gray 600 */
        }
        select:focus, option:hover {
            background-color: #374151; /* Even darker gray on focus/hover */
            border-color: #a78bfa; /* Light purple ring */
        }

    </style>
</head>
<body class="antialiased">
    <!-- STATIC TOP HEADER BANNER: Daily Expression - live English as it is -->
    <header class="w-full bg-gray-900 border-b-2 border-yellow-300 shadow-2xl py-3 mb-4">
        <div class="max-w-4xl mx-auto text-center px-4">
            <h2 class="text-xl sm:text-2xl font-extrabold text-yellow-300 tracking-wider uppercase">
                Daily Expression - live English as it is
            </h2>
        </div>
    </header>
    <!-- END STATIC TOP HEADER BANNER -->

    <div class="container">
        <!-- Dashboard de Progresso do Aluno (Gamifica√ß√£o) -->
        <div id="progress-dashboard" class="bg-gray-800 p-6 rounded-xl shadow-xl border border-purple-700 mb-8">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 flex items-center">
                ‚ú® Seu Progresso no RealTalk Daby
            </h2>
            <div id="progress-loading-indicator" class="progress-loading">
                <div class="loader-lg"></div>
                <p class="ml-4 text-gray-400">Carregando progresso...</p>
            </div>
            <div id="progress-content" class="grid grid-cols-3 gap-4 text-center hidden">

                <!-- N√≠vel de Flu√™ncia -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">N√≠vel de Flu√™ncia</p>
                    <p class="text-xl font-bold text-purple-400 mt-1" id="fluency-level">Carregando...</p>
                    <div class="mt-2 h-2 bg-gray-600 rounded-full">
                        <div class="h-2 bg-green-500 rounded-full" id="fluency-progress" style="width: 0%;"></div>
                    </div>
                    <p class="text-xs text-green-400 mt-1" id="fluency-target">Carregando...</p>
                </div>

                <!-- Express√µes Dominadas -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">Express√µes Dominadas</p>
                    <p class="text-xl font-bold text-yellow-400 mt-1 flex justify-center items-center">
                        <span class="mr-2">‚≠ê</span> <span id="mastered-count">0</span> / 11000
                    </p>
                    <p class="text-xs text-gray-400 mt-1" id="user-id-display">ID: N√£o autenticado</p>
                </div>

                <!-- Pontos Acumulados -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">Pontos Acumulados</p>
                    <p class="text-xl font-bold text-cyan-400 mt-1 flex justify-center items-center">
                        <span class="mr-2">üí∞</span> <span id="points-count">0</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1" id="next-reward-target">Carregando...</p>
                </div>
            </div>
        </div>
        <!-- Fim do Dashboard -->

        <!-- Card de Destaque - "Express√£o do Dia" -->
        <div id="expression-card" class="mb-10 p-6 rounded-xl shadow-2xl bg-gradient-to-r from-purple-800 to-indigo-900 border border-purple-500">
            <header class="text-center">
                <p class="text-sm font-semibold uppercase text-purple-200 mb-2">Express√£o do Dia (Review)</p>
                <h1 class="text-6xl font-black text-yellow-300 mb-2 leading-tight" id="card-expression">
                    Carregando...
                </h1>
                <p class="text-xl text-indigo-200 italic mb-4" id="card-meaning">
                    Significado: Carregando...
                </p>
                <button onclick="window.loadLesson(1); return false;" class="px-6 py-3 bg-yellow-400 text-gray-900 font-bold rounded-full hover:bg-yellow-300 transition duration-300 transform hover:scale-105 shadow-lg">
                    Aprender Mais
                </button>
            </header>
        </div>
        <!-- Fim do Card de Destaque -->

        <!-- Navigation Bar -->
        <nav class="flex overflow-x-auto p-4 bg-gray-900 border-b border-purple-800 shadow-xl mb-8 rounded-xl">
            <div class="flex space-x-4 mx-auto">
                <!-- Links de navega√ß√£o est√°ticos, pois n√£o h√° PHP para ger√°-los dinamicamente -->
                <a href="#" onclick="window.loadLesson(1); return false;" id="nav-1" 
                   class="flex-shrink-0 px-4 py-2 rounded-full font-medium transition duration-300 ease-in-out bg-purple-600 text-white hover:bg-purple-700">
                    Lesson 1: I am beat
                </a>
                <a href="#" onclick="window.loadLesson(2); return false;" id="nav-2" 
                   class="flex-shrink-0 px-4 py-2 rounded-full font-medium transition duration-300 ease-in-out bg-gray-700 text-purple-300 hover:bg-purple-500 hover:text-white">
                    Lesson 2: I'm hitting the hay
                </a>
                <!-- Adicione mais li√ß√µes aqui manualmente se necess√°rio -->
            </div>
        </nav>

        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-purple-400 mb-2 hidden" id="lesson-expression">
                <!-- Expression moved to card -->
            </h1>
            <p class="text-xl text-gray-400 italic hidden" id="lesson-title">
                <!-- Title moved to card -->
            </p>
        </header>

        <div id="lesson-content" class="space-y-8">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
            <p>RealTalk Daby (Corporate Edition) - Building practical fluency, one expression at a time.</p>
        </footer>

    </div>

    <script>
        // --- ATEN√á√ÉO: API_KEY e FIREBASE_CONFIG est√£o hardcoded aqui para HTML puro. ---
        // --- Em um ambiente de produ√ß√£o, isso n√£o √© recomendado por quest√µes de seguran√ßa. ---
        // --- Considere usar um backend para gerenciar chaves sens√≠veis. ---
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <-- SUBSTITUA PELA SUA CHAVE REAL DO GEMINI
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_FIREBASE_API_KEY", // <-- SUBSTITUA PELA SUA CHAVE REAL DO FIREBASE
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID",
            measurementId: "YOUR_FIREBASE_MEASUREMENT_ID",
        };
        const APP_ID = "default-app-id"; // Usado para o path no Firestore
        const INITIAL_AUTH_TOKEN = null; // Se voc√™ tiver um token customizado, coloque-o aqui.

        // Definir POINTS_PER_QUIZ e POINTS_PER_CHALLENGE
        const POINTS_PER_QUIZ = 10;
        const POINTS_PER_CHALLENGE = 50;

        // --- LESSON DATA (Hardcoded no JavaScript para HTML puro) ---
        const LESSONS_DATA = {
            1: {
                id: 1,
                expression: 'I am beat',
                title: 'Daily Expression: I am Beat!',
                focus: 'Informal Expressions of Fatigue',
                meaning_pt: 'Estou exausto / muito cansado',
                literal_translation: 'Eu estou batido',
                context_explanation: 'Usamos "I am beat" para expressar que estamos extremamente cansados, exaustos, como se tiv√©ssemos sido "derrotados" pelo cansa√ßo. √â uma forma mais informal e enf√°tica de dizer "I am very tired".',
                brazilian_analogy: 'Pense em "Estou morto de cansa√ßo", "Estou acabado" ou "Estou mo√≠do".',
                typical_scenario_pt: 'Trabalhei demais no sol do Rio hoje. **I am beat**!',
                grammar_focus: 'Estrutura: Subject + verb "to be" + beat (usado como adjetivo). Ex: I am beat, You are beat, He is beat. N√£o confunda com o verbo "to beat".',
                common_mistake: '"I am very tired, I will go to bed." (Correto, mas b√°sico).',
                native_say: "I'm totally **beat**, I'm heading home.",
                example_sentences: [
                    'After running the marathon, I was completely beat.',
                    'I worked 12 hours today. I am beat!',
                    'Can we just relax tonight? I am beat from cleaning all day.',
                    'He looks totally beat after his trip.',
                ],
                synonyms: [
                    "I'm exhausted (Exausto, mais formal)",
                    "I'm worn out (Esgotado, bom para uso di√°rio)",
                    "I'm wiped out (Destru√≠do, muito informal)",
                    "I am bits (Novo, informal/g√≠ria)"
                ],
                etymology: 'A express√£o "beat" tem uma origem incerta, mas √© usada em contextos de esporte e competi√ß√£o desde o s√©culo XIX, onde significava ser "derrotado" ou "esmagado". O sentido de "exausto" √© uma extens√£o natural: a fadiga "derrotou" a pessoa.',
                dialogue: [
                    {speaker: 'Liam', english_line: "Hey, are you coming to the gym with us?", portuguese_line: "Ei, voc√™ vem para a academia conosco?"},
                    {speaker: 'Sarah', english_line: "I wish I could, but I am beat! I worked a double shift.", portuguese_line: "Eu queria, mas estou exausta! Eu trabalhei em turno duplo."},
                    {speaker: 'Liam', english_line: "Ah, I get it. Hit the hay early then!", portuguese_line: "Ah, entendi. V√° dormir cedo ent√£o!"}
                ],
                gamification_question: "Complete a frase: Depois de um dia longo, eu estou ______.",
                gamification_answer: 'beat',
                gamification_hint: 'Pense na express√£o que significa "muito cansado".',
                contextual_match: {
                    question: "Em qual cen√°rio a express√£o 'I am beat' seria mais apropriada?",
                    options: [
                        {text: "Acabei de ganhar na loteria!", correct: false},
                        {text: "Passei a noite inteira estudando para o exame final.", correct: true},
                        {text: "Estou ansioso para come√ßar o trabalho.", correct: false}
                    ],
                    correct_index: 1
                },
                production_prompt: "Escreva uma frase que voc√™ usaria hoje para dizer que est√° extremamente cansado.",
                scenario_english_q: "Your boss asks if you can take on an extra project right now, but you just finished a 10-hour shift. What is your polite, but informal, reply using the expression?",
                scenario_english_a: "I'm sorry, but I am beat. Can we talk about this tomorrow?",
                translation_challenge_1_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Estou exausto depois de cortar a grama o dia todo!'",
                translation_challenge_1_a: "I am beat after mowing the lawn all day!",
                translation_challenge_2_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Ele parecia totalmente esgotado depois daquela viagem de neg√≥cios de tr√™s dias.'",
                translation_challenge_2_a: "He looked totally beat after that three-day business trip."
            },
            2: {
                id: 2,
                expression: "I'm hitting the hay",
                title: "Daily Expression: I'm Hitting the Hay!",
                focus: 'Informal Expressions of Sleep',
                meaning_pt: 'Vou dormir / Vou para a cama / Vou me deitar',
                literal_translation: 'Eu estou batendo no feno',
                context_explanation: 'This idiom means "I am going to bed." The phrase comes from the time when hay (haystacks) was often used as bedding. It is a very common and informal way to announce you are going to sleep.',
                brazilian_analogy: 'Pense em "Vou capotar" ou "Vou apagar".',
                typical_scenario_pt: 'N√£o aguento mais esse seriado. Vou **I\'m hitting the hay**!',
                grammar_focus: "Structure: Subject + verb 'to be' + verb 'hitting' + the hay. 'Hitting the hay' is the fixed idiomatic verb phrase.",
                common_mistake: '"I go to sleep now, I am very tired." (Correto, mas literal).',
                native_say: "I'm totally beat, so I'm **hitting the hay** early tonight.",
                example_sentences: [
                    'It‚Äôs midnight; I think I‚Äôll hit the hay.',
                    "I have an early flight tomorrow, so I'm hitting the hay now.",
                    'She looks like she needs to hit the hay.',
                    'Let‚Äôs watch one more episode, then I‚Äôm hitting the hay.',
                ],
                synonyms: [
                    "I'm going to bed (Formal/Standard)",
                    "I'm crashing (Informal, often implies immediate need for sleep)",
                    "I'm turning in (Slightly less informal)",
                    "I'm going to sleep"
                ],
                etymology: 'A frase √© uma met√°fora rural que remonta ao s√©culo XVII. Antes de colch√µes modernos, as pessoas dormiam em sacos de tecido preenchidos com feno (hay). Ir para a cama significava literalmente "bater no feno" para torn√°-lo mais confort√°vel.',
                dialogue: [
                    {speaker: 'Mark', english_line: "It‚Äôs getting late. I'm hitting the hay.", portuguese_line: "Est√° ficando tarde. Eu vou para a cama."},
                    {speaker: 'Chloe', english_line: "Already? But the movie just started!", portuguese_line: "J√°? Mas o filme acabou de come√ßar!"},
                    {speaker: 'Mark', english_line: "I know, but I'm totally beat and need to be up at six.", portuguese_line: "Eu sei, mas estou totalmente exausto e preciso acordar √†s seis."}
                ],
                gamification_question: "Complete a frase: It's late and I'm exhausted, time to ______.",
                gamification_answer: 'hit the hay',
                gamification_hint: 'Pense na express√£o para ir dormir.',
                contextual_match: {
                    question: "Em qual cen√°rio a express√£o 'I\'m hitting the hay' √© tipicamente usada?",
                    options: [
                        {text: "Quando voc√™ est√° saindo para uma festa.", correct: false},
                        {text: "Quando voc√™ est√° anunciando que vai se deitar para dormir.", correct: true},
                        {text: "Quando voc√™ est√° comendo feno.", correct: false}
                    ],
                    correct_index: 1
                },
                production_prompt: "Escreva uma frase que voc√™ usaria para se despedir dos amigos e anunciar que vai dormir.",
                scenario_english_q: "Your roommate wants to watch one more movie, but it's 2 AM and you have an early start. How do you tell them you're leaving the room and going to bed?",
                scenario_english_a: "That movie sounds great, but I'm hitting the hay right now.",
                translation_challenge_1_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Vou me deitar cedo hoje, porque tenho que acordar antes do sol nascer.'",
                translation_challenge_1_a: "I'm hitting the hay early tonight, because I have to wake up before sunrise.",
                translation_challenge_2_q: "Traduza para o ingl√™s, usando a express√£o de hoje: '√â melhor eu ir para a cama; j√° passa da meia-noite.'",
                translation_challenge_2_a: "I'd better hit the hay; it's already past midnight."
            }
        };


        // Fun√ß√£o para expor loadLesson ao escopo global
        window.loadLesson = function(id) {
            // ... (o conte√∫do da fun√ß√£o loadLesson ser√° movido para dentro do m√≥dulo)
        };
        window.playExpression = function(text, buttonId) { /* ... */ }; // Placeholder para evitar erros
        window.toggleTranslation = function(id) { /* ... */ }; // Placeholder para evitar erros
        window.checkRecallAnswer = function(lessonId, quizType, correctAnswer, hint) { /* ... */ }; // Placeholder
        window.checkMatch = function(lessonId, quizType, selectedIndex, isCorrect) { /* ... */ }; // Placeholder
        window.submitProduction = function(lessonId, quizType, expression) { /* ... */ }; // Placeholder
        window.checkScenarioAnswer = function(lessonId, quizType, expression, expectedAnswer) { /* ... */ }; // Placeholder
        window.checkTranslationAnswer = function(lessonId, quizType, challengeNumber, expression, expectedTranslation) { /* ... */ }; // Placeholder
        window.completeChallenge = function(lessonId) { /* ... */ }; // Placeholder

    </script>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, runTransaction, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        // setLogLevel foi removido conforme a corre√ß√£o anterior.

        // Vari√°veis globais de ambiente (agora hardcoded no JS para HTML puro)
        const appId = APP_ID;
        const firebaseConfig = FIREBASE_CONFIG;
        const initialAuthToken = INITIAL_AUTH_TOKEN;

        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let progressDocRef = null;
        let masteredLessons = {}; // Para controlar quais li√ß√µes o usu√°rio j√° dominou (evitar pontos duplicados)
        let activeLessonId = 1; // Para manter o controle da li√ß√£o ativa

        // --- 1. FIREBASE SETUP & PROGRESS DASHBOARD LOGIC ---

        // Configura os n√≠veis de flu√™ncia
        const FLUENCY_LEVELS = [
            { name: "Iniciante", minPoints: 0, maxPoints: 500 },
            { name: "Intermedi√°rio", minPoints: 501, maxPoints: 1500 },
            { name: "Avan√ßado", minPoints: 1501, maxPoints: 99999 } // Max points √© alto para o n√≠vel final
        ];

        // Inicializa o Firebase e a Autentica√ß√£o
        async function setupFirebase() {
            // Verifica se as chaves do Firebase s√£o placeholders
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YOUR_FIREBASE_API_KEY')) {
                console.warn("Firebase config not fully available or API Key is placeholder. Running in non-persistent mode for progress.");
                // Esconde o dashboard se o Firebase n√£o estiver configurado
                document.getElementById('progress-dashboard').classList.add('hidden');
                // Carrega a li√ß√£o sem depender do Firebase
                window.loadLesson(activeLessonId);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Tenta habilitar persist√™ncia offline (opcional, mas bom para UX)
                try {
                    await enableIndexedDbPersistence(db);
                    console.log("Offline persistence enabled.");
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Multiple tabs open, persistence could not be enabled.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("The current browser does not support all of the features required to enable persistence.");
                    } else {
                        console.error("Error enabling persistence:", err);
                    }
                }

                // Autentica√ß√£o: tenta usar o token customizado, sen√£o assina anonimamente.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `ID: ${userId.substring(0, 8)}...`;

                        // Define a refer√™ncia do documento de progresso
                        progressDocRef = doc(db, `artifacts/${appId}/users/${userId}/progress`, 'userProgress');

                        // Inicia o listener em tempo real
                        startProgressListener();
                        // Carrega a primeira li√ß√£o ap√≥s a autentica√ß√£o
                        window.loadLesson(activeLessonId);

                    } else {
                        console.log("Usu√°rio deslogado.");
                        isAuthReady = false;
                        // Se n√£o houver usu√°rio, ainda podemos carregar a li√ß√£o, mas sem salvar progresso
                        window.loadLesson(activeLessonId);
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                // Em caso de erro, ainda tenta carregar a li√ß√£o
                window.loadLesson(activeLessonId);
            }
        }

        // Fun√ß√£o para iniciar o listener de progresso do Firestore
        function startProgressListener() {
            if (!isAuthReady || !progressDocRef) return;

            // Escuta em tempo real o documento de progresso
            onSnapshot(progressDocRef, (docSnap) => {
                let data;
                if (docSnap.exists()) {
                    data = docSnap.data();
                } else {
                    // Documento n√£o existe, cria o estado inicial
                    data = { points: 0, mastered: {} };
                    setDoc(progressDocRef, data).catch(e => console.error("Error creating initial progress doc:", e));
                }
                updateProgressDashboard(data.points, data.mastered);
            }, (error) => {
                console.error("Error listening to progress:", error);
                // Em caso de erro, ainda exibe o dashboard com dados padr√£o
                updateProgressDashboard(0, {});
            });
        }

        // Atualiza o Dashboard de Progresso
        function updateProgressDashboard(currentPoints, masteredQuizzes) {
            document.getElementById('progress-loading-indicator').classList.add('hidden');
            document.getElementById('progress-content').classList.remove('hidden');

            const pointsCountElem = document.getElementById('points-count');
            const masteredCountElem = document.getElementById('mastered-count');
            const fluencyLevelElem = document.getElementById('fluency-level');
            const fluencyProgressElem = document.getElementById('fluency-progress');
            const fluencyTargetElem = document.getElementById('fluency-target');
            const nextRewardTargetElem = document.getElementById('next-reward-target');

            pointsCountElem.textContent = currentPoints;
            masteredLessons = masteredQuizzes || {}; // Atualiza o objeto global de li√ß√µes dominadas

            // Conta li√ß√µes dominadas (apenas uma vez por lessonId, independentemente do quizType)
            const uniqueMasteredLessons = new Set();
            for (const quizId in masteredLessons) {
                if (masteredLessons[quizId]) {
                    const lessonIdMatch = quizId.match(/(\d+)$/); // Extrai o ID da li√ß√£o do quizId
                    if (lessonIdMatch) {
                        uniqueMasteredLessons.add(parseInt(lessonIdMatch[1]));
                    }
                }
            }
            masteredCountElem.textContent = uniqueMasteredLessons.size;

            let currentLevel = FLUENCY_LEVELS[0];
            let nextLevel = null;

            for (let i = 0; i < FLUENCY_LEVELS.length; i++) {
                if (currentPoints >= FLUENCY_LEVELS[i].minPoints) {
                    currentLevel = FLUENCY_LEVELS[i];
                    if (i + 1 < FLUENCY_LEVELS.length) {
                        nextLevel = FLUENCY_LEVELS[i + 1];
                    } else {
                        nextLevel = null; // J√° est√° no n√≠vel m√°ximo
                    }
                } else {
                    break;
                }
            }

            fluencyLevelElem.textContent = currentLevel.name;

            let progressPercentage = 0;
            if (nextLevel) {
                const pointsInCurrentLevel = currentPoints - currentLevel.minPoints;
                const pointsNeededForNextLevel = nextLevel.maxPoints - currentLevel.minPoints;
                progressPercentage = (pointsInCurrentLevel / pointsNeededForNextLevel) * 100;
                fluencyTargetElem.textContent = `${Math.round(nextLevel.maxPoints - currentPoints)} pontos para ${nextLevel.name}`;
            } else {
                progressPercentage = 100; // N√≠vel m√°ximo
                fluencyTargetElem.textContent = "N√≠vel M√°ximo Atingido! üéâ";
            }
            fluencyProgressElem.style.width = `${Math.min(100, progressPercentage)}%`;

            // Exemplo de pr√≥xima recompensa (pode ser ajustado)
            const nextReward = Math.ceil((currentPoints + 1) / 1000) * 1000;
            nextRewardTargetElem.textContent = `Pr√≥xima recompensa em ${nextReward}`;

            // Atualiza o estado dos bot√µes de desafio di√°rio para a li√ß√£o ativa
            updateDailyChallengeButtonState(activeLessonId);
        }

        // Atualiza o progresso do usu√°rio no Firestore
        async function updateProgress(pointsToAdd, quizId, isMastered = false) {
            if (!isAuthReady || !progressDocRef) {
                console.warn("Firebase not ready or user not authenticated. Progress will not be saved.");
                return;
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(progressDocRef);
                    if (!sfDoc.exists()) {
                        transaction.set(progressDocRef, { points: pointsToAdd, mastered: { [quizId]: isMastered } });
                    } else {
                        const newPoints = (sfDoc.data().points || 0) + pointsToAdd;
                        const newMastered = { ...sfDoc.data().mastered, [quizId]: isMastered };
                        transaction.update(progressDocRef, { points: newPoints, mastered: newMastered });
                    }
                });
                console.log("Progress updated successfully!");
            } catch (e) {
                console.error("Transaction failed: ", e);
            }
        }

        // --- 2. TEXT-TO-SPEECH (TTS) LOGIC (Gemini API) ---
        let audioQueue = [];
        let isPlaying = false;

        async function playExpression(text, buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.disabled = true;
                button.textContent = 'üîä';
            }

            audioQueue.push({ text, buttonId });
            if (!isPlaying) {
                processAudioQueue();
            }
        }
        window.playExpression = playExpression; // Expor ao escopo global

        async function processAudioQueue() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const { text, buttonId } = audioQueue.shift();
            const button = document.getElementById(buttonId);

            try {
                // Verifica se a API_KEY √© um placeholder
                if (API_KEY.includes('YOUR_GEMINI_API_KEY')) {
                    console.warn("Gemini API Key is a placeholder. TTS will not function.");
                    if (button) {
                        button.textContent = '‚ùå';
                        button.disabled = false;
                    }
                    isPlaying = false;
                    processAudioQueue();
                    return;
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-preview-0514:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Generate a natural-sounding audio for the English phrase: "${text}"`
                            }]
                        }],
                        generationConfig: {
                            responseMimeType: "audio/mpeg", // Solicita MP3
                        },
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${JSON.stringify(errorData)}`);
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                audio.onended = () => {
                    if (button) {
                        button.textContent = '‚ñ∂Ô∏è';
                        button.disabled = false;
                    }
                    URL.revokeObjectURL(audioUrl);
                    processAudioQueue();
                };
                audio.onerror = (e) => {
                    console.error("Audio playback error:", e);
                    if (button) {
                        button.textContent = '‚ö†Ô∏è';
                        button.disabled = false;
                    }
                    URL.revokeObjectURL(audioUrl);
                    processAudioQueue();
                };
                audio.play();

            } catch (error) {
                console.error("Error generating or playing audio:", error);
                if (button) {
                    button.textContent = '‚ùå';
                    button.disabled = false;
                }
                processAudioQueue();
            }
        }

        // --- 3. LESSON RENDERING LOGIC ---

        // Fun√ß√£o para normalizar strings (para compara√ß√µes sem case/acentos)
        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Fun√ß√£o para renderizar um bloco de li√ß√£o
        function renderLessonBlock(title, content) {
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">${title}</h3>
                    <p class="text-gray-300 leading-relaxed">${content.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }

        // Fun√ß√£o para renderizar exemplos de frases
        function renderExampleSentences(sentences) {
            const listItems = sentences.map(s => `<li class="mb-2">${s}</li>`).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üé¨ 5. Real-Life Scenarios and Examples</h3>
                    <ul class="list-none text-gray-300 animated-bullets">
                        ${listItems}
                    </ul>
                </div>
            `;
        }

        // Fun√ß√£o para renderizar sin√¥nimos
        function renderSynonyms(synonyms) {
            const listItems = synonyms.map(s => {
                const parts = s.split('(', 2);
                const expressionPart = parts[0].trim();
                const explanationPart = parts[1] ? `(${parts[1]}` : '';
                return `<li><span class="font-bold text-yellow-300">${expressionPart}</span> ${explanationPart}</li>`;
            }).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üîó 6. Related Expressions and Synonyms</h3>
                    <p class="text-gray-300 leading-relaxed">To expand your vocabulary, here are other ways to express it, from formal to highly informal:</p>
                    <ul class="list-disc list-inside mt-3 ml-4 space-y-1 text-gray-300">
                        ${listItems}
                    </ul>
                </div>
            `;
        }

        // Fun√ß√£o para renderizar o bloco de di√°logo
        function renderDialogueBlock(dialogue, lessonId) {
            const dialogueHtml = dialogue.map((line, index) => {
                const speakerClass = (index % 2 === 0) ? 'speaker-a' : 'speaker-b';
                return `
                    <div class="dialogue-box flex items-center p-4 ${speakerClass}">
                        <div class="flex-grow">
                            <p class="font-bold text-lg mb-1">${line.speaker}:</p>
                            <p class="text-xl">${line.english_line}</p>
                            <p id="translation-${lessonId}-${index}" class="text-sm italic text-gray-300 mt-1 hidden">${line.portuguese_line}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4 space-x-2">
                            <button onclick="window.playExpression('${line.english_line.replace(/'/g, "\\'")}', 'dialogue-play-${lessonId}-${index}')" id="dialogue-play-${lessonId}-${index}" class="px-3 py-1 bg-purple-700 text-white rounded-full text-sm hover:bg-purple-800 transition duration-150">‚ñ∂Ô∏è</button>
                            <button onclick="window.toggleTranslation('${lessonId}-${index}')" class="px-3 py-1 bg-indigo-700 text-white rounded-full text-sm hover:bg-indigo-800 transition duration-150">PT</button>
                        </div>
                    </div>
                `;
            }).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üó£Ô∏è 8. Interactive Mini-Dialogue</h3>
                    <p class="text-gray-300 leading-relaxed mb-4">Ou√ßa e pratique a express√£o em um contexto de conversa real.</p>
                    <div class="space-y-4">
                        ${dialogueHtml}
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para alternar a tradu√ß√£o do di√°logo
        function toggleTranslation(id) {
            const translationElem = document.getElementById(`translation-${id}`);
            if (translationElem) {
                translationElem.classList.toggle('hidden');
            }
        }
        window.toggleTranslation = toggleTranslation; // Expor ao escopo global

        // Fun√ß√£o para renderizar o bloco de etimologia
        function renderEtymologyBlock(etymology) {
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üí° 10. Curiosities and Origin of the Expression</h3>
                    <p class="text-gray-300 leading-relaxed">${etymology.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }

        // Fun√ß√£o para renderizar o bloco de desafio di√°rio
        function renderDailyChallengeBlock(lessonId, expression) {
            return `
                <div id="exercise-11" class="lesson-block bg-gradient-to-br from-purple-900 to-indigo-900 p-6 rounded-xl shadow-2xl border-2 border-yellow-400 text-white">
                    <h4 class="text-2xl font-bold text-yellow-300 mb-3 flex items-center">üî• 11. Miss√£o de Aplica√ß√£o Real</h4>
                    <p class="text-gray-100 mb-4 text-lg font-light">
                        <strong>Desafio Di√°rio:</strong> Use a express√£o de hoje (<span class="font-bold text-yellow-300" id="challenge-expression-${lessonId}">${expression}</span>) em uma conversa real (com um colega, amigo, ou at√© mesmo pensando em voz alta).
                        <br>
                        <span class="text-sm italic">Registre sua experi√™ncia e sinta o progresso.</span>
                    </p>
                    <textarea id="challenge-input-${lessonId}" rows="3" class="w-full p-4 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-yellow-500 transition duration-150" placeholder="Ex: 'I tried saying I was beat, and my friend understood immediately!'"></textarea>
                    <button onclick="window.completeChallenge(${lessonId})" id="complete-challenge-button-${lessonId}" class="mt-4 w-full md:w-auto px-8 py-3 bg-yellow-400 text-gray-900 font-extrabold rounded-lg hover:bg-yellow-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-md">
                        Concluir Miss√£o (+${POINTS_PER_CHALLENGE} Pontos)
                    </button>
                    <p id="challenge-feedback-${lessonId}" class="mt-4 text-lg font-semibold text-white"></p>
                </div>
            `;
        }

        // Fun√ß√£o principal para carregar a li√ß√£o
        async function loadLesson(id) {
            activeLessonId = id; // Atualiza a li√ß√£o ativa
            const data = LESSONS_DATA[id];
            if (!data) {
                document.getElementById('lesson-content').innerHTML = '<p class="text-red-500 text-center text-2xl">Li√ß√£o n√£o encontrada!</p>';
                return;
            }

            // Atualiza o t√≠tulo da p√°gina
            document.getElementById('app-title').textContent = `RealTalk Daby (Corporate Edition) - ${data.title}`;

            // Atualiza o card de destaque
            document.getElementById('card-expression').textContent = data.expression;
            document.getElementById('card-meaning').textContent = `Significado: ${data.meaning_pt}`;
            document.querySelector('#expression-card button').onclick = () => window.loadLesson(data.id); // Garante que o bot√£o "Aprender Mais" carregue a li√ß√£o correta

            // Atualiza a navega√ß√£o
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('bg-purple-600', 'text-white');
                link.classList.add('bg-gray-700', 'text-purple-300', 'hover:bg-purple-500', 'hover:text-white');
            });
            const activeNavLink = document.getElementById(`nav-${id}`);
            if (activeNavLink) {
                activeNavLink.classList.remove('bg-gray-700', 'text-purple-300', 'hover:bg-purple-500', 'hover:text-white');
                activeNavLink.classList.add('bg-purple-600', 'text-white');
            }

            const lessonContentDiv = document.getElementById('lesson-content');
            let htmlContent = '';

            // 1. Express√£o e Significado
            htmlContent += renderLessonBlock(
                `‚ú® 1. Express√£o: <span class="highlight">${data.expression}</span>`,
                `**Significado:** ${data.meaning_pt}<br>**Tradu√ß√£o Literal:** ${data.literal_translation}`
            );

            // 2. Contexto e Explica√ß√£o
            htmlContent += renderLessonBlock(
                'üí¨ 2. Contexto e Explica√ß√£o',
                data.context_explanation
            );

            // 3. Analogia Brasileira
            htmlContent += renderLessonBlock(
                'üáßüá∑ 3. Analogia Brasileira',
                data.brazilian_analogy
            );

            // 4. Gram√°tica e Uso
            htmlContent += renderLessonBlock(
                'üìö 4. Gram√°tica e Uso',
                data.grammar_focus
            );

            // 5. Cen√°rios e Exemplos
            htmlContent += renderExampleSentences(data.example_sentences);

            // 6. Express√µes Relacionadas e Sin√¥nimos
            htmlContent += renderSynonyms(data.synonyms);

            // 7. Erro Comum
            htmlContent += renderLessonBlock(
                '‚ö†Ô∏è 7. Erro Comum',
                data.common_mistake
            );

            // 8. Di√°logo Interativo
            if (data.dialogue && data.dialogue.length > 0) {
                htmlContent += renderDialogueBlock(data.dialogue, data.id);
            }

            // 9. O que um Nativo Diria
            htmlContent += renderLessonBlock(
                'üó£Ô∏è 9. O que um Nativo Diria',
                data.native_say
            );

            // 10. Curiosidades e Origem
            if (data.etymology) {
                htmlContent += renderEtymologyBlock(data.etymology);
            }

            // --- Exerc√≠cios de Gamifica√ß√£o ---

            // Exerc√≠cio 1: Recall (Fill-in-the-blank)
            htmlContent += `
                <div id="exercise-1" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">üéØ Exerc√≠cio 1: Recall (Complete a Frase)</h4>
                    <p class="text-gray-300 mb-4">${data.gamification_question}</p>
                    <input type="text" id="recall-input-${data.id}" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150" placeholder="Sua resposta aqui..." data-attempts="0">
                    <button onclick="window.checkRecallAnswer(${data.id}, 'recall', '${data.gamification_answer.replace(/'/g, "\\'")}', '${data.gamification_hint.replace(/'/g, "\\'")}')" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300">Verificar</button>
                    <p id="recall-feedback-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Exerc√≠cio 2: Contextual Match (Multiple Choice)
            const matchOptionsHtml = data.contextual_match.options.map((option, index) => `
                <button onclick="window.checkMatch(${data.id}, 'context-match', ${index}, ${option.correct ? 'true' : 'false'})" 
                        class="option-button w-full text-left p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-200">
                    ${option.text}
                </button>
            `).join('');
            htmlContent += `
                <div id="exercise-2" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">üß† Exerc√≠cio 2: Contextual Match (M√∫ltipla Escolha)</h4>
                    <p class="text-gray-300 mb-4">${data.contextual_match.question}</p>
                    <div class="space-y-3">
                        ${matchOptionsHtml}
                    </div>
                    <p id="match-feedback-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Exerc√≠cio 3: Production (Creative Sentence)
            htmlContent += `
                <div id="exercise-3" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">‚úçÔ∏è Exerc√≠cio 3: Production (Crie sua Frase)</h4>
                    <p class="text-gray-300 mb-4">${data.production_prompt}</p>
                    <textarea id="production-input-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150" placeholder="Escreva sua frase aqui..."></textarea>
                    <button onclick="window.submitProduction(${data.id}, 'production', '${data.expression.replace(/'/g, "\\'")}')" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300">Verificar</button>
                    <p id="production-feedback-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Exerc√≠cio 4: Scenario Application (English Response)
            htmlContent += `
                <div id="exercise-4" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">üí¨ Exerc√≠cio 4: Scenario Application (Responda em Ingl√™s)</h4>
                    <p class="text-gray-300 mb-4">${data.scenario_english_q}</p>
                    <textarea id="scenario-input-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150" placeholder="Sua resposta em ingl√™s aqui..."></textarea>
                    <button onclick="window.checkScenarioAnswer(${data.id}, 'scenario', '${data.expression.replace(/'/g, "\\'")}', '${data.scenario_english_a.replace(/'/g, "\\'")}')" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300">Verificar</button>
                    <p id="scenario-feedback-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Exerc√≠cio 5: Translation Challenge 1 (PT to EN)
            htmlContent += `
                <div id="exercise-5" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">üìù Exerc√≠cio 5: Translation Challenge (PT para EN)</h4>
                    <p class="text-gray-300 mb-4">${data.translation_challenge_1_q}</p>
                    <textarea id="translation-input-1-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150" placeholder="Sua tradu√ß√£o em ingl√™s aqui..."></textarea>
                    <button onclick="window.checkTranslationAnswer(${data.id}, 'translation-1', 1, '${data.expression.replace(/'/g, "\\'")}', '${data.translation_challenge_1_a.replace(/'/g, "\\'")}')" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300">Verificar</button>
                    <p id="translation-feedback-1-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Exerc√≠cio 6: Translation Challenge 2 (PT to EN)
            htmlContent += `
                <div id="exercise-6" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-yellow-400 mb-3">üìù Exerc√≠cio 6: Translation Challenge (PT para EN)</h4>
                    <p class="text-gray-300 mb-4">${data.translation_challenge_2_q}</p>
                    <textarea id="translation-input-2-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150" placeholder="Sua tradu√ß√£o em ingl√™s aqui..."></textarea>
                    <button onclick="window.checkTranslationAnswer(${data.id}, 'translation-2', 2, '${data.expression.replace(/'/g, "\\'")}', '${data.translation_challenge_2_a.replace(/'/g, "\\'")}')" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300">Verificar</button>
                    <p id="translation-feedback-2-${data.id}" class="mt-4 text-lg font-semibold"></p>
                </div>
            `;

            // Miss√£o de Aplica√ß√£o Real (Desafio Di√°rio)
            htmlContent += renderDailyChallengeBlock(data.id, data.expression);

            lessonContentDiv.innerHTML = htmlContent;

            // Atualiza o estado dos bot√µes de desafio di√°rio para a li√ß√£o rec√©m-carregada
            updateDailyChallengeButtonState(data.id);
        }
        window.loadLesson = loadLesson; // Expor ao escopo global

        // --- 4. FEEDBACK ANIMATIONS ---
        function applySuccessFeedback(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('confetti-flash');
                setTimeout(() => {
                    element.classList.remove('confetti-flash');
                }, 400); // Dura√ß√£o da anima√ß√£o
            }
        }

        function applyErrorFeedback(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('shake');
                setTimeout(() => {
                    element.classList.remove('shake');
                }, 500); // Dura√ß√£o da anima√ß√£o
            }
        }

        // --- 5. QUIZ LOGIC (Movido do PHP para JS) ---

        // Marca um quiz como completo e adiciona pontos
        async function markQuizComplete(lessonId, quizType, points, isMastered = false) {
            const quizId = `${quizType}-${lessonId}`;
            // Para translation challenges, o quizId precisa ser mais espec√≠fico
            if (quizType.startsWith('translation-')) {
                quizId = `${quizType}-${lessonId}`; // J√° est√° formatado corretamente
            }

            if (masteredLessons[quizId]) {
                return false; // J√° completado, n√£o adiciona pontos
            }

            // Atualiza Firestore para dar pontos e registrar a li√ß√£o como masterizada
            await updateProgress(points, quizId, isMastered);

            // Retorna true indicando que o ponto foi contabilizado
            return true;
        }

        // 5.1 Check Recall Answer (Fill-in-the-blank)
        async function checkRecallAnswer(lessonId, quizType, correctAnswer, hint) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`recall-input-${lessonId}`);
            const feedback = document.getElementById(`recall-feedback-${lessonId}`);

            if (masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';
            const userAnswer = normalizeString(input.value);
            const correctText = correctAnswer.toUpperCase();

            const acceptedAnswers = [normalizeString(correctAnswer)];
            if (!correctAnswer.includes(' ')) {
                acceptedAnswers.push(`i am ${normalizeString(correctAnswer)}`);
                acceptedAnswers.push(`i'm ${normalizeString(correctAnswer)}`);
            }

            if (acceptedAnswers.includes(userAnswer)) {
                await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true);
                feedback.innerHTML = `üéâ **Perfect!** Voc√™ lembrou da express√£o principal! (+${POINTS_PER_QUIZ} Pontos)`;
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
            } else {
                let attempts = parseInt(input.dataset.attempts || 0) + 1;
                input.dataset.attempts = attempts;

                let feedbackText = '';

                if (attempts >= 3) {
                    feedbackText = `‚ùå Muitas tentativas. A resposta correta √©: "${correctText}".`;
                    input.value = '';
                    input.dataset.attempts = 0;
                    feedback.classList.add('text-red-500');
                } else {
                    feedbackText = `ü§î Tente novamente. Dica: ${hint}`;
                    feedback.classList.add('text-yellow-400');
                }

                feedback.innerHTML = feedbackText;
                applyErrorFeedback(input.id);
            }
        }
        window.checkRecallAnswer = checkRecallAnswer; // Expor ao escopo global

        // 5.2 Check Contextual Match (Multiple Choice)
        async function checkMatch(lessonId, quizType, selectedIndex, isCorrect) {
            const quizId = `${quizType}-${lessonId}`;
            const feedback = document.getElementById(`match-feedback-${lessonId}`);
            feedback.className = 'mt-4 text-lg font-semibold';

            const optionsContainer = document.querySelector(`#exercise-2 .space-y-3`);
            optionsContainer.querySelectorAll('button').forEach((btn, index) => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-600', 'option-button', 'hover:scale-105');
                if (index === selectedIndex) {
                    btn.classList.remove('bg-gray-700');
                    if (isCorrect) {
                        btn.classList.add('correct-answer', 'confetti-flash');
                    } else {
                        btn.classList.add('incorrect-answer', 'shake');
                    }
                } else if (LESSONS_DATA[lessonId].contextual_match.correct_index === index) {
                    btn.classList.add('correct-answer', 'opacity-50');
                }
            });

            if (isCorrect) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `‚úÖ **Excelente!** O contexto de uso est√° correto. (+${POINTS_PER_QUIZ} Pontos)`;
                } else {
                    feedback.innerHTML = `‚úÖ **Excelente!** O contexto de uso est√° correto.`;
                }
                feedback.classList.add('text-green-400');
            } else {
                feedback.innerHTML = '‚ùå **Quase l√°!** A express√£o √© usada para indicar a situa√ß√£o de **maior cansa√ßo/sono**.';
                feedback.classList.add('text-red-500');
            }
        }
        window.checkMatch = checkMatch; // Expor ao escopo global

        // 5.3 Submit Production Sentence
        async function submitProduction(lessonId, quizType, expression) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`production-input-${lessonId}`);
            const feedback = document.getElementById(`production-feedback-${lessonId}`);
            const sentence = input.value.trim();

            if (masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Sua frase parece boa. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (sentence.length < 5) {
                feedback.innerHTML = '‚ö†Ô∏è **Por favor, escreva uma frase completa.**';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            const expressionLower = normalizeString(expression);
            const lowerSentence = normalizeString(sentence);

            let isUsed = lowerSentence.includes(expressionLower) || (expressionLower === 'i am beat' && lowerSentence.includes('beat')) || (expressionLower === "i'm hitting the hay" && lowerSentence.includes('hit the hay'));

            if (isUsed) {
                const ptWords = ['muito', 'o', 'a', 'de', 'para', 'eu', 'voc√™', 'meu', 'minha', 'um', 'uma', 'uns', 'umas', 'e', 'mas', 'ou', 'se', 'n√£o', 'sim', 'com', 'sem', 'em', 'no', 'na', 'nos', 'nas', 'por', 'para', 'de', 'do', 'da', 'dos', 'das', 'entre', 'sobre', 'sob', 'ap√≥s', 'antes', 'at√©', 'desde', 'durante', 'contra', 'perante', 'atr√°s', 'frente', 'dentro', 'fora', 'acima', 'abaixo', 'perto', 'longe', 'aqui', 'ali', 'l√°', 'onde', 'quando', 'como', 'porque', 'portanto', 'entretanto', 'todavia', 'contudo', 'assim', 'tamb√©m', 'ainda', 'j√°', 'sempre', 'nunca', 'quase', 'apenas', 's√≥', 'muito', 'pouco', 'mais', 'menos', 'melhor', 'pior', 'bom', 'boa', 'mal', 'bem', 'grande', 'pequeno', 'novo', 'velho', 'certo', 'errado', 'feliz', 'triste', 'bonito', 'feio', 'r√°pido', 'lento', 'f√°cil', 'dif√≠cil', 'claro', 'escuro', 'quente', 'frio', 'cheio', 'vazio', 'aberto', 'fechado', 'limpo', 'sujo', 'forte', 'fraco', 'alto', 'baixo', 'rico', 'pobre', 'jovem', 'velho']; // Lista mais abrangente de palavras em portugu√™s
                let errorFound = ptWords.some(word => lowerSentence.includes(word));

                let guidance = '';
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    guidance = `üëç **√ìtimo uso!** Sua frase √© natural e usa a express√£o no contexto correto. (+${POINTS_PER_QUIZ} Pontos)`;
                } else {
                    guidance = 'üëç **√ìtimo uso!** Sua frase √© natural e usa a express√£o no contexto correto.';
                }

                if (errorFound) {
                    guidance += '<br><span class="text-yellow-300">üí° **Pequena Revis√£o:** Encontrei algumas palavras que parecem ser de portugu√™s. Verifique se sua frase √© 100% em ingl√™s.</span>';
                    feedback.classList.add('text-yellow-400');
                    applySuccessFeedback(input.id); // Ainda √© um sucesso, mas com um aviso
                } else {
                    guidance += '<br><span class="text-green-300">‚úÖ **Feedback Gramatical B√°sico:** A estrutura da frase parece correta e a pontua√ß√£o √© boa. Parab√©ns!</span>';
                    feedback.classList.add('text-green-400');
                    applySuccessFeedback(input.id);
                }

                feedback.innerHTML = guidance;

            } else {
                feedback.innerHTML = `‚ùå **Revise sua frase.** A express√£o ("${expression}") n√£o parece ter sido inclu√≠da. Tente novamente!`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.submitProduction = submitProduction; // Expor ao escopo global

        // 5.4 Check Scenario Answer
        async function checkScenarioAnswer(lessonId, quizType, expression, expectedAnswer) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`scenario-input-${lessonId}`);
            const feedback = document.getElementById(`scenario-feedback-${lessonId}`);
            const userAnswer = normalizeString(input.value);
            const expressionLower = normalizeString(expression);
            const expectedText = expectedAnswer;

            if (masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (input.value.length < 10) {
                feedback.innerHTML = '‚ö†Ô∏è Por favor, escreva uma resposta completa √† situa√ß√£o.';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            if (userAnswer.includes(expressionLower) || (expressionLower === 'i am beat' && userAnswer.includes('beat'))) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `üéâ **Resposta Excelente!** Voc√™ aplicou a express√£o corretamente no cen√°rio. Exemplo de resposta: <span class="text-green-300 italic">"${expectedText}"</span>. (+${POINTS_PER_QUIZ} Pontos)`;
                } else {
                    feedback.innerHTML = `üéâ **Resposta Excelente!** Voc√™ aplicou a express√£o corretamente no cen√°rio. Exemplo de resposta: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                }
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
            } else {
                feedback.innerHTML = `‚ùå **Quase l√°.** Sua resposta n√£o cont√©m a express√£o "${expression}". Lembre-se, o objetivo √© us√°-la.`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.checkScenarioAnswer = checkScenarioAnswer; // Expor ao escopo global

        // 5.5 & 5.6 Check Translation Answer
        async function checkTranslationAnswer(lessonId, quizType, challengeNumber, expression, expectedTranslation) {
            const quizId = `${quizType}-${challengeNumber}-${lessonId}`; // quizType agora inclui o challengeNumber
            const input = document.getElementById(`translation-input-${challengeNumber}-${lessonId}`);
            const feedback = document.getElementById(`translation-feedback-${challengeNumber}-${lessonId}`);
            const userAnswer = normalizeString(input.value);
            const expressionLower = normalizeString(expression);
            const expectedText = expectedTranslation;

            if (masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (input.value.length < 10) {
                feedback.innerHTML = '‚ö†Ô∏è Por favor, escreva a tradu√ß√£o completa.';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            if (userAnswer.includes(expressionLower) || (expressionLower === 'i am beat' && userAnswer.includes('beat'))) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `üéâ **Tradu√ß√£o Correta!** Voc√™ usou a express√£o no contexto da frase. Uma tradu√ß√£o ideal seria: <span class="text-green-300 italic">"${expectedText}"</span>. (+${POINTS_PER_QUIZ} Pontos)`;
                } else {
                    feedback.innerHTML = `üéâ **Tradu√ß√£o Correta!** Voc√™ usou a express√£o no contexto da frase. Uma tradu√ß√£o ideal seria: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                }
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
            } else {
                feedback.innerHTML = `‚ùå **Tradu√ß√£o Incorreta.** Sua frase em ingl√™s n√£o cont√©m a express√£o "${expression}". Reveja a se√ß√£o de significado!`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.checkTranslationAnswer = checkTranslationAnswer; // Expor ao escopo global

        // 5.7 Daily Challenge Completion
        async function completeChallenge(lessonId) {
            const quizId = `daily-challenge-${lessonId}`;
            const input = document.getElementById(`challenge-input-${lessonId}`);
            const feedback = document.getElementById(`challenge-feedback-${lessonId}`);
            const button = document.getElementById(`complete-challenge-button-${lessonId}`);
            const challengeText = input.value.trim();

            if (masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                feedback.classList.add('text-green-400');
                return;
            }

            if (challengeText.length < 20) { // Exige uma resposta mais elaborada
                feedback.innerHTML = '‚ö†Ô∏è Por favor, descreva sua experi√™ncia com mais detalhes (m√≠nimo 20 caracteres).';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            // Simplesmente marca como completo e d√° pontos, pois √© um desafio de auto-relato
            if (await markQuizComplete(lessonId, quizId, POINTS_PER_CHALLENGE, true)) {
                feedback.innerHTML = `üéâ **Miss√£o Conclu√≠da!** Parab√©ns por aplicar a express√£o na vida real! (+${POINTS_PER_CHALLENGE} Pontos)`;
                feedback.classList.add('text-green-400');
                applySuccessFeedback(button.id);
                button.disabled = true;
                button.textContent = 'Miss√£o Conclu√≠da! ‚úÖ';
            } else {
                feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                feedback.classList.add('text-green-400');
            }
        }
        window.completeChallenge = completeChallenge; // Expor ao escopo global

        // Fun√ß√£o para atualizar o estado do bot√£o do desafio di√°rio
        function updateDailyChallengeButtonState(lessonId) {
            const quizId = `daily-challenge-${lessonId}`;
            const button = document.getElementById(`complete-challenge-button-${lessonId}`);
            const feedback = document.getElementById(`challenge-feedback-${lessonId}`);

            if (button) {
                if (masteredLessons[quizId]) {
                    button.disabled = true;
                    button.textContent = 'Miss√£o Conclu√≠da! ‚úÖ';
                    feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                    feedback.classList.add('text-green-400');
                } else {
                    button.disabled = false;
                    button.textContent = `Concluir Miss√£o (+${POINTS_PER_CHALLENGE} Pontos)`;
                    feedback.innerHTML = ''; // Limpa feedback se n√£o estiver completo
                }
            }
        }

        // Carrega a li√ß√£o 1 assim que o DOM estiver pronto e o Firebase setup for conclu√≠do
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase(); // Inicia o Firebase, que por sua vez chamar√° loadLesson(activeLessonId)
        });

    </script>
</body>
</html>
