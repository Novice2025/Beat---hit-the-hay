<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">RealTalk Daby (Corporate Edition) - Daily Expression</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for dark mode and fonts */
        body {
            font-family: 'Verdana', 'Segoe UI', Tahoma, Geneva, sans-serif; /* Simula um estilo de escrita mais limpo */
            background-color: #030712; /* Deeper Dark background */
            color: #e5e7eb; /* Light text */
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        .highlight {
            background-color: #4c1d95; /* Accent color (Dark Purple) */
            color: #fcd34d; /* Yellow text for highlights */
            padding: 0.2em 0.5em;
            border-radius: 0.3em;
            display: inline-block;
            font-weight: 600;
        }
        /* Animation for bullet points */
        ul.animated-bullets li::before {
            content: 'üí¨'; /* Chat/message icon */
            margin-right: 0.5em;
            animation: bounce 1s infinite alternate;
            color: #a78bfa; /* Light Purple color */
        }
        @keyframes bounce {
            0% { transform: translateY(0); }
            100% { transform: translateY(-3px); }
        }
        .loader {
            border: 4px solid #3b82f6;
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        .loader-lg { /* Loader para o dashboard */
            border: 6px solid #3b82f6;
            border-top: 6px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .option-button {
            transition: all 0.2s;
        }
        .option-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(76, 29, 149, 0.5);
        }
        .correct-answer {
            background-color: #15803d !important; /* Green 700 */
        }
        .incorrect-answer {
            background-color: #b91c1c !important; /* Red 700 */
        }

        /* --- NEW ANIMATION STYLES FOR GAMIFICATION --- */
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        /* Success/Confetti Simulation: A dramatic flash effect */
        .confetti-flash {
            animation: success-flash 0.4s ease-out;
            box-shadow: 0 0 15px 5px #fcd34d, 0 0 5px 2px #a78bfa;
        }
        @keyframes success-flash {
            0% { opacity: 0.5; transform: scale(1.0); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1.0); }
        }

        /* Dialogue Box Styling */
        .dialogue-box {
            background-color: #1f2937; /* Darker gray for the box */
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            display: flex; /* Para alinhar o texto e os bot√µes */
            align-items: center; /* Centraliza verticalmente */
        }
        .speaker-a {
            background-color: #312e81; /* Indigo 800 */
            color: #eef2ff;
            border-radius: 0.75rem 0.75rem 0.1rem 0.75rem;
        }
        .speaker-b {
            background-color: #8338ec; /* Custom Purple/Fuchsia */
            color: white;
            border-radius: 0.75rem 0.75rem 0.75rem 0.1rem;
        }
        /* Loader/Indicator for Dashboard */
        .progress-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        /* Custom styles for dropdowns in dark mode */
        select, option {
            background-color: #1f2937; /* Darker gray */
            color: #e5e7eb; /* Light text */
            border: 1px solid #4b5563; /* Gray 600 */
        }
        select:focus, option:hover {
            background-color: #374151; /* Even darker gray on focus/hover */
            border-color: #a78bfa; /* Light purple ring */
        }

        /* --- NEW GAMING VISUALS --- */
        /* Floating Points Animation */
        .floating-points {
            position: absolute;
            font-weight: bold;
            color: #fcd34d; /* Yellow */
            font-size: 1.5rem; /* text-2xl */
            opacity: 0;
            animation: floatUpAndFade 1.5s ease-out forwards;
            pointer-events: none; /* N√£o interfere com cliques */
            z-index: 1000; /* Garante que fique acima de outros elementos */
            text-shadow: 0 0 5px rgba(252, 211, 77, 0.7); /* Pequena sombra para destaque */
        }
        @keyframes floatUpAndFade {
            0% { transform: translateY(0); opacity: 1; }
            70% { transform: translateY(-30px); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        /* Progress Bar Smooth Transition */
        #fluency-progress {
            transition: width 0.5s ease-out;
        }

        /* Audio Button Loading Spinner */
        .audio-loading .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-width: 2px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .audio-loading .play-icon {
            display: none;
        }

    </style>
</head>
<body class="antialiased">
    <!-- STATIC TOP HEADER BANNER: Daily Expression - live English as it is -->
    <header class="w-full bg-gray-900 border-b-2 border-yellow-300 shadow-2xl py-3 mb-4">
        <div class="max-w-4xl mx-auto text-center px-4">
            <h2 class="text-xl sm:text-2xl font-extrabold text-yellow-300 tracking-wider uppercase">
                Daily Expression - live English as it is
            </h2>
        </div>
    </header>
    <!-- END STATIC TOP HEADER BANNER -->

    <div class="container">
        <!-- Dashboard de Progresso do Aluno (Gamifica√ß√£o) -->
        <div id="progress-dashboard" class="bg-gray-800 p-6 rounded-xl shadow-xl border border-purple-700 mb-8">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 flex items-center">
                ‚ú® Seu Progresso no RealTalk Daby
            </h2>
            <div id="progress-loading-indicator" class="progress-loading">
                <div class="loader-lg"></div>
                <p class="ml-4 text-gray-400">Carregando progresso...</p>
            </div>
            <div id="progress-content" class="grid grid-cols-3 gap-4 text-center hidden">

                <!-- N√≠vel de Flu√™ncia -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">N√≠vel de Flu√™ncia</p>
                    <p class="text-xl font-bold text-purple-400 mt-1" id="fluency-level">Carregando...</p>
                    <div class="mt-2 h-2 bg-gray-600 rounded-full">
                        <div class="h-2 bg-green-500 rounded-full" id="fluency-progress" style="width: 0%;"></div>
                    </div>
                    <p class="text-xs text-green-400 mt-1" id="fluency-target">Carregando...</p>
                </div>

                <!-- Express√µes Dominadas -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">Express√µes Dominadas</p>
                    <p class="text-xl font-bold text-yellow-400 mt-1 flex justify-center items-center">
                        <span class="mr-2">‚≠ê</span> <span id="mastered-count">0</span> / 11000
                    </p>
                    <p class="text-xs text-gray-400 mt-1" id="user-id-display">ID: N√£o autenticado</p>
                </div>

                <!-- Pontos Acumulados -->
                <div class="p-3 bg-gray-900 rounded-lg">
                    <p class="text-sm text-gray-400 uppercase">Pontos Acumulados</p>
                    <p class="text-xl font-bold text-cyan-400 mt-1 flex justify-center items-center">
                        <span class="mr-2">üí∞</span> <span id="points-count">0</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1" id="next-reward-target">Carregando...</p>
                </div>
            </div>
        </div>
        <!-- Fim do Dashboard -->

        <!-- Card de Destaque - "Express√£o do Dia" -->
        <div id="expression-card" class="mb-10 p-6 rounded-xl shadow-2xl bg-gradient-to-r from-purple-800 to-indigo-900 border border-purple-500">
            <header class="text-center">
                <p class="text-sm font-semibold uppercase text-purple-200 mb-2">Express√£o do Dia (Review)</p>
                <h1 class="text-6xl font-black text-yellow-300 mb-2 leading-tight" id="card-expression">
                    Carregando...
                </h1>
                <p class="text-xl text-indigo-200 italic mb-4" id="card-meaning">
                    Significado: Carregando...
                </p>
                <button onclick="window.loadLesson(1); return false;" class="px-6 py-3 bg-yellow-400 text-gray-900 font-bold rounded-full hover:bg-yellow-300 transition duration-300 transform hover:scale-105 shadow-lg">
                    Aprender Mais
                </button>
            </header>
        </div>
        <!-- Fim do Card de Destaque -->

        <!-- Navigation Bar -->
        <nav class="flex overflow-x-auto p-4 bg-gray-900 border-b border-purple-800 shadow-xl mb-8 rounded-xl">
            <div class="flex space-x-4 mx-auto">
                <!-- Links de navega√ß√£o est√°ticos, pois n√£o h√° PHP para ger√°-los dinamicamente -->
                <a href="#" onclick="window.loadLesson(1); return false;" id="nav-1" 
                   class="flex-shrink-0 px-4 py-2 rounded-full font-medium transition duration-300 ease-in-out bg-purple-600 text-white hover:bg-purple-700">
                    Lesson 1: I am beat
                </a>
                <a href="#" onclick="window.loadLesson(2); return false;" id="nav-2" 
                   class="flex-shrink-0 px-4 py-2 rounded-full font-medium transition duration-300 ease-in-out bg-gray-700 text-purple-300 hover:bg-purple-500 hover:text-white">
                    Lesson 2: I'm hitting the hay
                </a>
                <!-- Adicione mais li√ß√µes aqui manualmente se necess√°rio -->
            </div>
        </nav>

        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold text-purple-400 mb-2 hidden" id="lesson-expression">
                <!-- Expression moved to card -->
            </h1>
            <p class="text-xl text-gray-400 italic hidden" id="lesson-title">
                <!-- Title moved to card -->
            </p>
        </header>

        <div id="lesson-content" class="space-y-8">
            <!-- Content will be rendered here by JavaScript -->
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm border-t border-gray-800 pt-6">
            <p>RealTalk Daby (Corporate Edition) - Building practical fluency, one expression at a time.</p>
        </footer>

    </div>

    <script>
        // --- ATEN√á√ÉO: API_KEY e FIREBASE_CONFIG est√£o hardcoded aqui para HTML puro. ---
        // --- Em um ambiente de produ√ß√£o, isso n√£o √© recomendado por quest√µes de seguran√ßa. ---
        // --- Considere usar um backend para gerenciar chaves sens√≠veis. ---
        const API_KEY = "YOUR_GEMINI_API_KEY_HERE"; // <-- SUBSTITUA PELA SUA CHAVE REAL DO GEMINI
        const FIREBASE_CONFIG = {
            apiKey: "YOUR_FIREBASE_API_KEY", // <-- SUBSTITUA PELA SUA CHAVE REAL DO FIREBASE
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID",
            measurementId: "YOUR_FIREBASE_MEASUREMENT_ID",
        };
        const APP_ID = "default-app-id"; // Usado para o path no Firestore
        const INITIAL_AUTH_TOKEN = null; // Se voc√™ tiver um token customizado, coloque-o aqui.

        // Definir POINTS_PER_QUIZ e POINTS_PER_CHALLENGE
        const POINTS_PER_QUIZ = 10;
        const POINTS_PER_CHALLENGE = 50;

        // --- LESSON DATA (Hardcoded no JavaScript para HTML puro) ---
        const LESSONS_DATA = {
            1: {
                id: 1,
                expression: 'I am beat',
                title: 'Daily Expression: I am Beat!',
                focus: 'Informal Expressions of Fatigue',
                meaning_pt: 'Estou exausto / muito cansado',
                literal_translation: 'Eu estou batido',
                context_explanation: 'Usamos "I am beat" para expressar que estamos extremamente cansados, exaustos, como se tiv√©ssemos sido "derrotados" pelo cansa√ßo. √â uma forma mais informal e enf√°tica de dizer "I am very tired".',
                brazilian_analogy: 'Pense em "Estou morto de cansa√ßo", "Estou acabado" ou "Estou mo√≠do".',
                typical_scenario_pt: 'Trabalhei demais no sol do Rio hoje. **I am beat**!',
                grammar_focus: 'Estrutura: Subject + verb "to be" + beat (usado como adjetivo). Ex: I am beat, You are beat, He is beat. N√£o confunda com o verbo "to beat".',
                common_mistake: '"I am very tired, I will go to bed." (Correto, mas b√°sico).',
                native_say: "I'm totally **beat**, I'm heading home.",
                example_sentences: [
                    'After running the marathon, I was completely beat.',
                    'I worked 12 hours today. I am beat!',
                    'Can we just relax tonight? I am beat from cleaning all day.',
                    'He looks totally beat after his trip.',
                ],
                synonyms: [
                    "I'm exhausted (Exausto, mais formal)",
                    "I'm worn out (Esgotado, bom para uso di√°rio)",
                    "I'm wiped out (Destru√≠do, muito informal)",
                    "I am bits (Novo, informal/g√≠ria)"
                ],
                etymology: 'A express√£o "beat" tem uma origem incerta, mas √© usada em contextos de esporte e competi√ß√£o desde o s√©culo XIX, onde significava ser "derrotado" ou "esmagado". O sentido de "exausto" √© uma extens√£o natural: a fadiga "derrotou" a pessoa.',
                dialogue: [
                    {speaker: 'Liam', english_line: "Hey, are you coming to the gym with us?", portuguese_line: "Ei, voc√™ vem para a academia conosco?"},
                    {speaker: 'Sarah', english_line: "I wish I could, but I am beat! I worked a double shift.", portuguese_line: "Eu queria, mas estou exausta! Eu trabalhei em turno duplo."},
                    {speaker: 'Liam', english_line: "Ah, I get it. Hit the hay early then!", portuguese_line: "Ah, entendi. V√° dormir cedo ent√£o!"}
                ],
                gamification_question: "Complete a frase: Depois de um dia longo, eu estou ______.",
                gamification_answer: 'beat',
                gamification_hint: 'Pense na express√£o que significa "muito cansado".',
                contextual_match: {
                    question: "Em qual cen√°rio a express√£o 'I am beat' seria mais apropriada?",
                    options: [
                        {text: "Acabei de ganhar na loteria!", correct: false},
                        {text: "Passei a noite inteira estudando para o exame final.", correct: true},
                        {text: "Estou ansioso para come√ßar o trabalho.", correct: false}
                    ],
                    correct_index: 1
                },
                production_prompt: "Escreva uma frase que voc√™ usaria hoje para dizer que est√° extremamente cansado.",
                scenario_english_q: "Your boss asks if you can take on an extra project right now, but you just finished a 10-hour shift. What is your polite, but informal, reply using the expression?",
                scenario_english_a: "I'm sorry, but I am beat. Can we talk about this tomorrow?",
                translation_challenge_1_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Estou exausto depois de cortar a grama o dia todo!'",
                translation_challenge_1_a: "I am beat after mowing the lawn all day!",
                translation_challenge_2_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Ele parecia totalmente esgotado depois daquela viagem de neg√≥cios de tr√™s dias.'",
                translation_challenge_2_a: "He looked totally beat after that three-day business trip."
            },
            2: {
                id: 2,
                expression: "I'm hitting the hay",
                title: "Daily Expression: I'm Hitting the Hay!",
                focus: 'Informal Expressions of Sleep',
                meaning_pt: 'Vou dormir / Vou para a cama / Vou me deitar',
                literal_translation: 'Eu estou batendo no feno',
                context_explanation: 'This idiom means "I am going to bed." The phrase comes from the time when hay (haystacks) was often used as bedding. It is a very common and informal way to announce you are going to sleep.',
                brazilian_analogy: 'Pense em "Vou capotar" ou "Vou apagar".',
                typical_scenario_pt: 'N√£o aguento mais esse seriado. Vou **I\'m hitting the hay**!',
                grammar_focus: "Structure: Subject + verb 'to be' + verb 'hitting' + the hay. 'Hitting the hay' is the fixed idiomatic verb phrase.",
                common_mistake: '"I go to sleep now, I am very tired." (Correto, mas literal).',
                native_say: "I'm totally beat, so I'm **hitting the hay** early tonight.",
                example_sentences: [
                    'It‚Äôs midnight; I think I‚Äôll hit the hay.',
                    "I have an early flight tomorrow, so I'm hitting the hay now.",
                    'She looks like she needs to hit the hay.',
                    'Let‚Äôs watch one more episode, then I‚Äôm hitting the hay.',
                ],
                synonyms: [
                    "I'm going to bed (Formal/Standard)",
                    "I'm crashing (Informal, often implies immediate need for sleep)",
                    "I'm turning in (Slightly less informal)",
                    "I'm going to sleep"
                ],
                etymology: 'A frase √© uma met√°fora rural que remonta ao s√©culo XVII. Antes de colch√µes modernos, as pessoas dormiam em sacos de tecido preenchidos com feno (hay). Ir para a cama significava literalmente "bater no feno" para torn√°-lo mais confort√°vel.',
                dialogue: [
                    {speaker: 'Mark', english_line: "It‚Äôs getting late. I'm hitting the hay.", portuguese_line: "Est√° ficando tarde. Eu vou para a cama."},
                    {speaker: 'Chloe', english_line: "Already? But the movie just started!", portuguese_line: "J√°? Mas o filme acabou de come√ßar!"},
                    {speaker: 'Mark', english_line: "I know, but I'm totally beat and need to be up at six.", portuguese_line: "Eu sei, mas estou totalmente exausto e preciso acordar √†s seis."}
                ],
                gamification_question: "Complete a frase: It's late and I'm exhausted, time to ______.",
                gamification_answer: 'hit the hay',
                gamification_hint: 'Pense na express√£o para ir dormir.',
                contextual_match: {
                    question: "Em qual cen√°rio a express√£o 'I\'m hitting the hay' √© tipicamente usada?",
                    options: [
                        {text: "Quando voc√™ est√° saindo para uma festa.", correct: false},
                        {text: "Quando voc√™ est√° anunciando que vai se deitar para dormir.", correct: true},
                        {text: "Quando voc√™ est√° comendo feno.", correct: false}
                    ],
                    correct_index: 1
                },
                production_prompt: "Escreva uma frase que voc√™ usaria para se despedir dos amigos e anunciar que vai dormir.",
                scenario_english_q: "Your roommate wants to watch one more movie, but it's 2 AM and you have an early start. How do you tell them you're leaving the room and going to bed?",
                scenario_english_a: "That movie sounds great, but I'm hitting the hay right now.",
                translation_challenge_1_q: "Traduza para o ingl√™s, usando a express√£o de hoje: 'Vou me deitar cedo hoje, porque tenho que acordar antes do sol nascer.'",
                translation_challenge_1_a: "I'm hitting the hay early tonight, because I have to wake up before sunrise.",
                translation_challenge_2_q: "Traduza para o ingl√™s, usando a express√£o de hoje: '√â melhor eu ir para a cama; j√° passa da meia-noite.'",
                translation_challenge_2_a: "I'd better hit the hay; it's already past midnight."
            }
        };

        // Fun√ß√£o para expor loadLesson ao escopo global
        window.loadLesson = function(id) {
            // Esta fun√ß√£o ser√° chamada pelo onclick dos bot√µes de navega√ß√£o.
            // A implementa√ß√£o real est√° dentro do m√≥dulo.
            // Apenas repassamos a chamada para a fun√ß√£o interna do m√≥dulo.
            if (typeof window._loadLessonInternal === 'function') {
                window._loadLessonInternal(id);
            } else {
                console.error("loadLessonInternal n√£o est√° dispon√≠vel ainda.");
            }
        };
    </script>

    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Vari√°veis globais para o m√≥dulo
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let userProgress = {
            points: 0,
            masteredLessons: {}, // { "quiz-type-lessonId": true }
            fluencyLevel: 'Iniciante',
            fluencyProgress: 0, // 0-100
            totalMastered: 0
        };
        let activeLessonId = 1; // Li√ß√£o ativa padr√£o

        // Cache para √°udios TTS
        const audioCache = {};
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // --- Fun√ß√µes de Utilit√°rio ---
        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // --- Fun√ß√µes de Feedback Visual (Gaming) ---
        function applySuccessFeedback(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('confetti-flash');
                setTimeout(() => {
                    element.classList.remove('confetti-flash');
                }, 400);
            }
        }

        function applyErrorFeedback(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('shake');
                setTimeout(() => {
                    element.classList.remove('shake');
                }, 500);
            }
        }

        function showFloatingPoints(points, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            if (!targetElement) return;

            const rect = targetElement.getBoundingClientRect();
            const floatingDiv = document.createElement('div');
            floatingDiv.textContent = `+${points} Pontos!`;
            floatingDiv.classList.add('floating-points');

            // Posiciona o div flutuante perto do elemento alvo
            floatingDiv.style.left = `${rect.left + window.scrollX + rect.width / 2}px`;
            floatingDiv.style.top = `${rect.top + window.scrollY - 20}px`;
            floatingDiv.style.transform = 'translateX(-50%)'; // Centraliza horizontalmente

            document.body.appendChild(floatingDiv);

            // Remove o elemento ap√≥s a anima√ß√£o
            floatingDiv.addEventListener('animationend', () => {
                floatingDiv.remove();
            });
        }

        // --- Fun√ß√µes de √Åudio TTS ---
        async function playExpression(text, buttonId) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.classList.add('audio-loading');
                button.innerHTML = '<div class="loader"></div>'; // Mostra spinner
            }

            if (audioCache[text]) {
                const source = audioContext.createBufferSource();
                source.buffer = audioCache[text];
                source.connect(audioContext.destination);
                source.start(0);
                source.onended = () => {
                    if (button) {
                        button.classList.remove('audio-loading');
                        button.innerHTML = '<span class="play-icon">‚ñ∂Ô∏è</span>'; // Volta ao √≠cone de play
                    }
                };
                return;
            }

            const MAX_RETRIES = 3;
            let retries = 0;

            while (retries < MAX_RETRIES) {
                try {
                    const response = await fetch(`https://texttospeech.googleapis.com/v1beta1/text:synthesize?key=${API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            input: { text: text },
                            voice: { languageCode: 'en-US', name: 'en-US-Wavenet-D' }, // Voz natural
                            audioConfig: { audioEncoding: 'LINEAR16', speakingRate: 0.95 } // Ajuste a velocidade
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('TTS API Error:', errorData);
                        throw new Error(`TTS API responded with status ${response.status}: ${errorData.error.message}`);
                    }

                    const data = await response.json();
                    const audioContent = data.audioContent;

                    if (audioContent) {
                        const audioBlob = base64ToArrayBuffer(audioContent);
                        audioContext.decodeAudioData(audioBlob, (buffer) => {
                            audioCache[text] = buffer;
                            const source = audioContext.createBufferSource();
                            source.buffer = buffer;
                            source.connect(audioContext.destination);
                            source.start(0);
                            source.onended = () => {
                                if (button) {
                                    button.classList.remove('audio-loading');
                                    button.innerHTML = '<span class="play-icon">‚ñ∂Ô∏è</span>';
                                }
                            };
                        }, (e) => {
                            console.error("Error decoding audio data", e);
                            if (button) {
                                button.classList.remove('audio-loading');
                                button.innerHTML = '<span class="play-icon">‚ñ∂Ô∏è</span>';
                            }
                        });
                        return; // Sucesso, sai do loop
                    } else {
                        throw new Error("No audio content received from TTS API.");
                    }
                } catch (error) {
                    console.error(`Attempt ${retries + 1} failed:`, error);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        await new Promise(res => setTimeout(res, 1000 * retries)); // Espera mais a cada tentativa
                    }
                }
            }
            console.error("Failed to play expression after multiple retries.");
            if (button) {
                button.classList.remove('audio-loading');
                button.innerHTML = '<span class="play-icon">‚ñ∂Ô∏è</span>';
            }
        }
        window.playExpression = playExpression; // Expor ao escopo global

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Fun√ß√£o para pr√©-carregar √°udios da li√ß√£o atual
        async function preloadLessonAudios(lessonData) {
            const textsToPreload = new Set();
            textsToPreload.add(lessonData.expression);
            lessonData.example_sentences.forEach(s => textsToPreload.add(s));
            if (lessonData.dialogue) {
                lessonData.dialogue.forEach(line => textsToPreload.add(line.english_line));
            }
            // Adicione outros textos que voc√™ queira pr√©-carregar

            for (const text of Array.from(textsToPreload)) {
                if (!audioCache[text]) {
                    // Chamar playExpression sem um buttonId para apenas cachear
                    // ou criar uma fun√ß√£o de cache dedicada para evitar a l√≥gica de UI
                    try {
                        const response = await fetch(`https://texttospeech.googleapis.com/v1beta1/text:synthesize?key=${API_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                input: { text: text },
                                voice: { languageCode: 'en-US', name: 'en-US-Wavenet-D' },
                                audioConfig: { audioEncoding: 'LINEAR16', speakingRate: 0.95 }
                            }),
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const audioContent = data.audioContent;
                            if (audioContent) {
                                const audioBlob = base64ToArrayBuffer(audioContent);
                                audioContext.decodeAudioData(audioBlob, (buffer) => {
                                    audioCache[text] = buffer;
                                }, (e) => console.error("Error decoding preloaded audio", e));
                            }
                        }
                    } catch (error) {
                        console.warn(`Failed to preload audio for "${text}":`, error);
                    }
                }
            }
        }


        // --- Fun√ß√µes do Firebase ---
        function setupFirebase() {
            if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey || FIREBASE_CONFIG.apiKey === "YOUR_FIREBASE_API_KEY") {
                console.warn("Firebase configuration is missing or using placeholder. Progress tracking will be disabled.");
                document.getElementById('progress-loading-indicator').classList.add('hidden');
                document.getElementById('progress-content').classList.remove('hidden');
                document.getElementById('user-id-display').textContent = 'ID: Desabilitado (Configura√ß√£o Firebase ausente)';
                isAuthReady = true; // Permite que o site funcione sem Firebase
                window._loadLessonInternal(activeLessonId); // Carrega a li√ß√£o mesmo sem Firebase
                return;
            }

            app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase authenticated. User ID:", userId);
                    document.getElementById('user-id-display').textContent = `ID: ${userId.substring(0, 8)}...`;
                    await loadUserProgress();
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in.");
                    try {
                        if (INITIAL_AUTH_TOKEN) {
                            await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase anonymous sign-in failed:", error);
                        document.getElementById('user-id-display').textContent = 'ID: Falha na autentica√ß√£o';
                    }
                }
                isAuthReady = true;
                window._loadLessonInternal(activeLessonId); // Carrega a li√ß√£o ap√≥s a autentica√ß√£o
            });
        }

        async function loadUserProgress() {
            if (!userId) return;

            const userDocRef = doc(db, "users", userId);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    userProgress = docSnap.data();
                    console.log("User progress loaded:", userProgress);
                } else {
                    console.log("No user progress found, creating new one.");
                    userProgress = {
                        points: 0,
                        masteredLessons: {},
                        fluencyLevel: 'Iniciante',
                        fluencyProgress: 0,
                        totalMastered: 0
                    };
                    setDoc(userDocRef, userProgress).catch(e => console.error("Error creating user doc:", e));
                }
                updateDashboardUI();
            }, (error) => {
                console.error("Error listening to user progress:", error);
            });
        }

        async function updateUserProgress(newPoints, quizId, isMastered) {
            if (!userId) {
                console.warn("User not authenticated, cannot update progress.");
                return false;
            }

            const userDocRef = doc(db, "users", userId);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    const currentProgress = userDoc.exists() ? userDoc.data() : userProgress;

                    let updatedPoints = currentProgress.points || 0;
                    let updatedMasteredLessons = currentProgress.masteredLessons || {};
                    let updatedTotalMastered = currentProgress.totalMastered || 0;

                    let pointsAdded = false;

                    if (isMastered && !updatedMasteredLessons[quizId]) {
                        updatedPoints += newPoints;
                        updatedMasteredLessons[quizId] = true;
                        updatedTotalMastered++;
                        pointsAdded = true;
                    }

                    // L√≥gica de n√≠vel de flu√™ncia (exemplo simples)
                    let newFluencyLevel = currentProgress.fluencyLevel;
                    let newFluencyProgress = currentProgress.fluencyProgress;

                    if (updatedTotalMastered < 5) {
                        newFluencyLevel = 'Iniciante';
                        newFluencyProgress = (updatedTotalMastered / 5) * 100;
                    } else if (updatedTotalMastered < 20) {
                        newFluencyLevel = 'B√°sico';
                        newFluencyProgress = ((updatedTotalMastered - 5) / 15) * 100;
                    } else if (updatedTotalMastered < 50) {
                        newFluencyLevel = 'Intermedi√°rio';
                        newFluencyProgress = ((updatedTotalMastered - 20) / 30) * 100;
                    } else {
                        newFluencyLevel = 'Avan√ßado';
                        newFluencyProgress = 100; // Ou outra l√≥gica para n√≠veis avan√ßados
                    }
                    newFluencyProgress = Math.min(100, Math.max(0, newFluencyProgress)); // Garante que esteja entre 0 e 100

                    transaction.set(userDocRef, {
                        points: updatedPoints,
                        masteredLessons: updatedMasteredLessons,
                        fluencyLevel: newFluencyLevel,
                        fluencyProgress: newFluencyProgress,
                        totalMastered: updatedTotalMastered
                    }, { merge: true });

                    if (pointsAdded) {
                        showFloatingPoints(newPoints, 'points-count'); // Mostra a anima√ß√£o de pontos
                    }
                    return pointsAdded; // Retorna se pontos foram adicionados
                });
                return true;
            } catch (e) {
                console.error("Transaction failed: ", e);
                return false;
            }
        }

        async function markQuizComplete(lessonId, quizType, points, isCorrect) {
            const quizId = `${quizType}-${lessonId}`;
            if (userProgress.masteredLessons[quizId]) {
                return false; // J√° completou, n√£o adiciona pontos novamente
            }
            if (isCorrect) {
                return await updateUserProgress(points, quizId, true);
            }
            return false;
        }

        function updateDashboardUI() {
            document.getElementById('progress-loading-indicator').classList.add('hidden');
            document.getElementById('progress-content').classList.remove('hidden');

            document.getElementById('points-count').textContent = userProgress.points;
            document.getElementById('mastered-count').textContent = userProgress.totalMastered;
            document.getElementById('fluency-level').textContent = userProgress.fluencyLevel;
            document.getElementById('fluency-progress').style.width = `${userProgress.fluencyProgress}%`;

            let nextLevelTarget = '';
            if (userProgress.fluencyLevel === 'Iniciante') {
                nextLevelTarget = `${5 - userProgress.totalMastered} para B√°sico`;
            } else if (userProgress.fluencyLevel === 'B√°sico') {
                nextLevelTarget = `${20 - userProgress.totalMastered} para Intermedi√°rio`;
            } else if (userProgress.fluencyLevel === 'Intermedi√°rio') {
                nextLevelTarget = `${50 - userProgress.totalMastered} para Avan√ßado`;
            } else {
                nextLevelTarget = 'N√≠vel M√°ximo!';
            }
            document.getElementById('fluency-target').textContent = nextLevelTarget;
            document.getElementById('next-reward-target').textContent = `Pr√≥xima recompensa em ${1000 - (userProgress.points % 1000)}`;
        }

        // --- Fun√ß√µes de Renderiza√ß√£o de Li√ß√µes ---
        function renderLessonBlock(title, content) {
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">${title}</h3>
                    <p class="text-gray-300 leading-relaxed">${content.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }

        function renderExampleSentences(sentences) {
            const listItems = sentences.map(s => `<li class="mb-2">${s}</li>`).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üé¨ 5. Real-Life Scenarios and Examples</h3>
                    <ul class="list-none text-gray-300 animated-bullets">
                        ${listItems}
                    </ul>
                </div>
            `;
        }

        function renderSynonyms(synonyms) {
            const listItems = synonyms.map(s => {
                const parts = s.split('(', 2);
                const expressionPart = parts[0].trim();
                const explanationPart = parts[1] ? `(${parts[1]}` : '';
                return `<li><span class="font-bold text-yellow-300">${expressionPart}</span> ${explanationPart}</li>`;
            }).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üîó 6. Related Expressions and Synonyms</h3>
                    <p class="text-gray-300 leading-relaxed">To expand your vocabulary, here are other ways to express it, from formal to highly informal:</p>
                    <ul class="list-disc list-inside mt-3 ml-4 space-y-1 text-gray-300">
                        ${listItems}
                    </ul>
                </div>
            `;
        }

        function renderDialogueBlock(dialogue, lessonId) {
            const dialogueHtml = dialogue.map((line, index) => {
                const speakerClass = (index % 2 === 0) ? 'speaker-a' : 'speaker-b';
                return `
                    <div class="dialogue-box flex items-center p-4 ${speakerClass}">
                        <div class="flex-grow">
                            <p class="font-bold text-lg mb-1">${line.speaker}:</p>
                            <p class="text-xl">${line.english_line}</p>
                            <p id="translation-${lessonId}-${index}" class="text-sm italic text-gray-300 mt-1 hidden">${line.portuguese_line}</p>
                        </div>
                        <div class="flex-shrink-0 ml-4 space-x-2">
                            <button onclick="window.playExpression('${line.english_line.replace(/'/g, "\\'")}', 'dialogue-play-${lessonId}-${index}')" id="dialogue-play-${lessonId}-${index}" class="px-3 py-1 bg-purple-700 text-white rounded-full text-sm hover:bg-purple-800 transition duration-150">
                                <span class="play-icon">‚ñ∂Ô∏è</span>
                            </button>
                            <button onclick="window.toggleTranslation('${lessonId}-${index}')" class="px-3 py-1 bg-indigo-700 text-white rounded-full text-sm hover:bg-indigo-800 transition duration-150">PT</button>
                        </div>
                    </div>
                `;
            }).join('');
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üó£Ô∏è 8. Interactive Mini-Dialogue</h3>
                    <p class="text-gray-300 leading-relaxed mb-4">Ou√ßa e pratique a express√£o em um contexto de conversa real.</p>
                    <div class="space-y-4">
                        ${dialogueHtml}
                    </div>
                </div>
            `;
        }
        window.toggleTranslation = function(id) {
            const element = document.getElementById(`translation-${id}`);
            if (element) {
                element.classList.toggle('hidden');
            }
        };

        function renderEtymologyBlock(etymology) {
            return `
                <div class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h3 class="text-xl font-semibold text-purple-400 mb-3">üí° 10. Curiosities and Origin of the Expression</h3>
                    <p class="text-gray-300 leading-relaxed">${etymology.replace(/\n/g, '<br>')}</p>
                </div>
            `;
        }

        function renderDailyChallengeBlock(lessonId, expression) {
            const quizId = `daily-challenge-${lessonId}`;
            const isCompleted = userProgress.masteredLessons[quizId];
            const buttonText = isCompleted ? 'Miss√£o Conclu√≠da! ‚úÖ' : `Concluir Miss√£o (+${POINTS_PER_CHALLENGE} Pontos)`;
            const buttonDisabled = isCompleted ? 'disabled' : '';
            const feedbackText = isCompleted ? `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.` : '';
            const feedbackClass = isCompleted ? 'text-green-400' : '';

            return `
                <div id="exercise-11" class="lesson-block bg-gradient-to-br from-purple-900 to-indigo-900 p-6 rounded-xl shadow-2xl border-2 border-yellow-400 text-white">
                    <h4 class="text-2xl font-bold text-yellow-300 mb-3 flex items-center">üî• 11. Miss√£o de Aplica√ß√£o Real</h4>
                    <p class="text-gray-100 mb-4 text-lg font-light">
                        <strong>Desafio Di√°rio:</strong> Use a express√£o de hoje (<span class="font-bold text-yellow-300" id="challenge-expression-${lessonId}">${expression}</span>) em uma conversa real (com um colega, amigo, ou at√© mesmo pensando em voz alta).
                        <br>
                        <span class="text-sm italic">Registre sua experi√™ncia e sinta o progresso.</span>
                    </p>
                    <textarea id="challenge-input-${lessonId}" rows="3" class="w-full p-4 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-yellow-500 transition duration-150" placeholder="Ex: 'I tried saying I was beat, and my friend understood immediately!'" ${isCompleted ? 'disabled' : ''}></textarea>
                    <button onclick="window.completeChallenge(${lessonId})" id="complete-challenge-button-${lessonId}" class="mt-4 w-full md:w-auto px-8 py-3 bg-yellow-400 text-gray-900 font-extrabold rounded-lg hover:bg-yellow-300 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                    <p id="challenge-feedback-${lessonId}" class="mt-4 text-lg font-semibold ${feedbackClass}">${feedbackText}</p>
                </div>
            `;
        }


        // --- Fun√ß√£o Principal de Carregamento de Li√ß√£o ---
        async function loadLesson(id) {
            if (!isAuthReady) {
                console.log("Firebase not ready, deferring lesson load.");
                activeLessonId = id; // Define a li√ß√£o a ser carregada ap√≥s a autentica√ß√£o
                return;
            }

            const data = LESSONS_DATA[id];
            if (!data) {
                console.error("Lesson data not found for ID:", id);
                return;
            }

            // Atualiza o t√≠tulo da p√°gina
            document.getElementById('app-title').textContent = `RealTalk Daby (Corporate Edition) - ${data.title}`;

            // Atualiza o card de destaque
            document.getElementById('card-expression').textContent = data.expression;
            document.getElementById('card-meaning').textContent = `Significado: ${data.meaning_pt}`;

            // Atualiza a navega√ß√£o
            document.querySelectorAll('nav a').forEach(link => {
                link.classList.remove('bg-purple-600', 'text-white');
                link.classList.add('bg-gray-700', 'text-purple-300', 'hover:bg-purple-500', 'hover:text-white');
            });
            const activeNavLink = document.getElementById(`nav-${id}`);
            if (activeNavLink) {
                activeNavLink.classList.remove('bg-gray-700', 'text-purple-300', 'hover:bg-purple-500', 'hover:text-white');
                activeNavLink.classList.add('bg-purple-600', 'text-white');
            }

            const lessonContentDiv = document.getElementById('lesson-content');
            let htmlContent = '';

            // Bloco 1: Express√£o e Significado
            htmlContent += renderLessonBlock(
                `üéØ 1. Express√£o: "${data.expression}"`,
                `**Significado:** ${data.meaning_pt}\n**Tradu√ß√£o Literal:** ${data.literal_translation}`
            );

            // Bloco 2: Contexto e Explica√ß√£o
            htmlContent += renderLessonBlock(
                'üìñ 2. Contexto e Explica√ß√£o',
                data.context_explanation
            );

            // Bloco 3: Analogia Brasileira
            htmlContent += renderLessonBlock(
                'üáßüá∑ 3. Analogia Brasileira',
                data.brazilian_analogy
            );

            // Bloco 4: Cen√°rio T√≠pico
            htmlContent += renderLessonBlock(
                'üí¨ 4. Cen√°rio T√≠pico',
                data.typical_scenario_pt
            );

            // Bloco 5: Exemplos de Frases
            htmlContent += renderExampleSentences(data.example_sentences);

            // Bloco 6: Express√µes Relacionadas e Sin√¥nimos
            htmlContent += renderSynonyms(data.synonyms);

            // Bloco 7: Foco Gramatical e Erros Comuns
            htmlContent += renderLessonBlock(
                'üìù 7. Foco Gramatical e Erros Comuns',
                `**Foco Gramatical:** ${data.grammar_focus}\n**Erro Comum:** ${data.common_mistake}\n**Como um Nativo Diria:** ${data.native_say}`
            );

            // Bloco 8: Mini-Di√°logo Interativo (NOVO)
            if (data.dialogue) {
                htmlContent += renderDialogueBlock(data.dialogue, data.id);
            }

            // Bloco 9: Exerc√≠cio de Gamifica√ß√£o (Preencher a Lacuna)
            const quizId1 = `fill-in-the-blank-${data.id}`;
            const isQuiz1Complete = userProgress.masteredLessons[quizId1];
            htmlContent += `
                <div id="exercise-1" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">üéÆ 9. Desafio R√°pido: Complete a Frase</h4>
                    <p class="text-gray-300 mb-4">${data.gamification_question}</p>
                    <input type="text" id="gamification-input-${data.id}" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-purple-500 transition duration-150" placeholder="Sua resposta aqui..." ${isQuiz1Complete ? 'disabled' : ''}>
                    <button onclick="window.checkAnswer(${data.id}, 'fill-in-the-blank', '${data.gamification_answer.replace(/'/g, "\\'")}', '${data.gamification_hint.replace(/'/g, "\\'")}')" id="gamification-button-${data.id}" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${isQuiz1Complete ? 'disabled' : ''}>
                        Verificar
                    </button>
                    <p id="gamification-feedback-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz1Complete ? 'text-green-400' : ''}">${isQuiz1Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio.` : ''}</p>
                </div>
            `;

            // Bloco 9.1: Exerc√≠cio de Contextual Match (M√∫ltipla Escolha)
            const quizId2 = `contextual-match-${data.id}`;
            const isQuiz2Complete = userProgress.masteredLessons[quizId2];
            const optionsHtml = data.contextual_match.options.map((option, index) => `
                <button onclick="window.checkMatch(${data.id}, 'contextual-match', ${index}, ${option.correct})" 
                        class="option-button w-full text-left p-3 rounded-lg bg-gray-700 hover:bg-gray-600 transition duration-200 ${isQuiz2Complete ? 'disabled' : ''}" ${isQuiz2Complete ? 'disabled' : ''}>
                    ${option.text}
                </button>
            `).join('');
            htmlContent += `
                <div id="exercise-2" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">ü§î 9.1. Desafio de Contexto: Escolha a Melhor Situa√ß√£o</h4>
                    <p class="text-gray-300 mb-4">${data.contextual_match.question}</p>
                    <div class="space-y-3">
                        ${optionsHtml}
                    </div>
                    <p id="match-feedback-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz2Complete ? 'text-green-400' : ''}">${isQuiz2Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio.` : ''}</p>
                </div>
            `;

            // Bloco 9.2: Exerc√≠cio de Produ√ß√£o de Frase
            const quizId3 = `production-sentence-${data.id}`;
            const isQuiz3Complete = userProgress.masteredLessons[quizId3];
            htmlContent += `
                <div id="exercise-3" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">‚úçÔ∏è 9.2. Sua Vez: Crie uma Frase</h4>
                    <p class="text-gray-300 mb-4">${data.production_prompt}</p>
                    <textarea id="production-input-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-purple-500 transition duration-150" placeholder="Sua frase em ingl√™s aqui..." ${isQuiz3Complete ? 'disabled' : ''}></textarea>
                    <button onclick="window.submitProduction(${data.id}, 'production-sentence', '${data.expression.replace(/'/g, "\\'")}')" id="production-button-${data.id}" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${isQuiz3Complete ? 'disabled' : ''}>
                        Verificar Frase
                    </button>
                    <p id="production-feedback-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz3Complete ? 'text-green-400' : ''}">${isQuiz3Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio.` : ''}</p>
                </div>
            `;

            // Bloco 9.3: Exerc√≠cio de Cen√°rio em Ingl√™s
            const quizId4 = `scenario-english-${data.id}`;
            const isQuiz4Complete = userProgress.masteredLessons[quizId4];
            htmlContent += `
                <div id="exercise-4" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">üé≠ 9.3. Roleplay: Responda ao Cen√°rio</h4>
                    <p class="text-gray-300 mb-4">${data.scenario_english_q}</p>
                    <textarea id="scenario-input-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-purple-500 transition duration-150" placeholder="Sua resposta em ingl√™s aqui..." ${isQuiz4Complete ? 'disabled' : ''}></textarea>
                    <button onclick="window.checkScenarioAnswer(${data.id}, 'scenario-english', '${data.expression.replace(/'/g, "\\'")}', '${data.scenario_english_a.replace(/'/g, "\\'")}')" id="scenario-button-${data.id}" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${isQuiz4Complete ? 'disabled' : ''}>
                        Verificar Resposta
                    </button>
                    <p id="scenario-feedback-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz4Complete ? 'text-green-400' : ''}">${isQuiz4Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: "${data.scenario_english_a}"` : ''}</p>
                </div>
            `;

            // Bloco 9.4: Desafio de Tradu√ß√£o 1
            const quizId5 = `translation-challenge-1-${data.id}`;
            const isQuiz5Complete = userProgress.masteredLessons[quizId5];
            htmlContent += `
                <div id="exercise-5" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">üåê 9.4. Desafio de Tradu√ß√£o (PT-EN)</h4>
                    <p class="text-gray-300 mb-4">${data.translation_challenge_1_q}</p>
                    <textarea id="translation-input-1-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-purple-500 transition duration-150" placeholder="Sua tradu√ß√£o em ingl√™s aqui..." ${isQuiz5Complete ? 'disabled' : ''}></textarea>
                    <button onclick="window.checkTranslationAnswer(${data.id}, 'translation-challenge', 1, '${data.expression.replace(/'/g, "\\'")}', '${data.translation_challenge_1_a.replace(/'/g, "\\'")}')" id="translation-button-1-${data.id}" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${isQuiz5Complete ? 'disabled' : ''}>
                        Verificar Tradu√ß√£o
                    </button>
                    <p id="translation-feedback-1-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz5Complete ? 'text-green-400' : ''}">${isQuiz5Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: "${data.translation_challenge_1_a}"` : ''}</p>
                </div>
            `;

            // Bloco 9.5: Desafio de Tradu√ß√£o 2
            const quizId6 = `translation-challenge-2-${data.id}`;
            const isQuiz6Complete = userProgress.masteredLessons[quizId6];
            htmlContent += `
                <div id="exercise-6" class="lesson-block bg-gray-800 p-6 rounded-xl shadow-lg mb-6 border border-gray-700">
                    <h4 class="text-xl font-semibold text-purple-400 mb-3">üåê 9.5. Desafio de Tradu√ß√£o (PT-EN)</h4>
                    <p class="text-gray-300 mb-4">${data.translation_challenge_2_q}</p>
                    <textarea id="translation-input-2-${data.id}" rows="3" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-purple-500 transition duration-150" placeholder="Sua tradu√ß√£o em ingl√™s aqui..." ${isQuiz6Complete ? 'disabled' : ''}></textarea>
                    <button onclick="window.checkTranslationAnswer(${data.id}, 'translation-challenge', 2, '${data.expression.replace(/'/g, "\\'")}', '${data.translation_challenge_2_a.replace(/'/g, "\\'")}')" id="translation-button-2-${data.id}" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out transform hover:scale-105 shadow-md" ${isQuiz6Complete ? 'disabled' : ''}>
                        Verificar Tradu√ß√£o
                    </button>
                    <p id="translation-feedback-2-${data.id}" class="mt-4 text-lg font-semibold ${isQuiz6Complete ? 'text-green-400' : ''}">${isQuiz6Complete ? `‚úÖ Correto. Voc√™ j√° ganhou os ¬®D{POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: "${data.translation_challenge_2_a}"` : ''}</p>
                </div>
            `;

            // Bloco 10: Curiosidades e Origem (NOVO)
            if (data.etymology) {
                htmlContent += renderEtymologyBlock(data.etymology);
            }

            // Bloco 11: Desafios Di√°rios/Miss√µes (NOVO)
            htmlContent += renderDailyChallengeBlock(data.id, data.expression);


            lessonContentDiv.innerHTML = htmlContent;

            // Pr√©-carrega os √°udios da li√ß√£o atual
            preloadLessonAudios(data);
        }
        window._loadLessonInternal = loadLesson; // Expor a fun√ß√£o interna para ser chamada pelo window.loadLesson

        // 5.1 Check Answer (Fill-in-the-blank)
        async function checkAnswer(lessonId, quizType, correctAnswer, hint) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`gamification-input-${lessonId}`);
            const feedback = document.getElementById(`gamification-feedback-${lessonId}`);
            const userAnswer = normalizeString(input.value);
            const expectedAnswers = correctAnswer.split('/').map(ans => normalizeString(ans)); // Suporta m√∫ltiplas respostas

            if (userProgress.masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (expectedAnswers.includes(userAnswer)) {
                await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true);
                feedback.innerHTML = `üéâ **Perfect!** Voc√™ lembrou da express√£o principal! (+${POINTS_PER_QUIZ} Pontos)`;
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
                input.disabled = true; // Desabilita o input ap√≥s o acerto
                document.getElementById(`gamification-button-${lessonId}`).disabled = true;
            } else {
                let attempts = parseInt(input.dataset.attempts || 0) + 1;
                input.dataset.attempts = attempts;

                let feedbackText = '';

                if (attempts >= 3) {
                    feedbackText = `‚ùå Muitas tentativas. A resposta correta √©: "${correctAnswer}".`;
                    input.value = ''; 
                    input.dataset.attempts = 0; 
                    feedback.classList.add('text-red-500');
                } else {
                    feedbackText = `ü§î Tente novamente. Dica: ${hint}`;
                    feedback.classList.add('text-yellow-400');
                }

                feedback.innerHTML = feedbackText;
                applyErrorFeedback(input.id);
            }
        }
        window.checkAnswer = checkAnswer; // Expor ao escopo global

        // 5.2 Check Contextual Match (Multiple Choice)
        async function checkMatch(lessonId, quizType, selectedIndex, isCorrect) {
            const quizId = `${quizType}-${lessonId}`;
            const feedback = document.getElementById(`match-feedback-${lessonId}`);
            feedback.className = 'mt-4 text-lg font-semibold';

            const optionsContainer = document.querySelector(`#exercise-2 .space-y-3`);
            optionsContainer.querySelectorAll('button').forEach((btn, index) => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-gray-600', 'option-button', 'hover:scale-105');
                if (index === selectedIndex) {
                    btn.classList.remove('bg-gray-700');
                    if (isCorrect) {
                        btn.classList.add('correct-answer', 'confetti-flash');
                    } else {
                        btn.classList.add('incorrect-answer', 'shake');
                    }
                } else if (LESSONS_DATA[lessonId].contextual_match.correct_index === index) {
                    btn.classList.add('correct-answer', 'opacity-50');
                }
            });

            if (isCorrect) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `‚úÖ **Excelente!** O contexto de uso est√° correto. (+${POINTS_PER_QUIZ} Pontos)`;
                } else {
                    feedback.innerHTML = `‚úÖ **Excelente!** O contexto de uso est√° correto.`;
                }
                feedback.classList.add('text-green-400');
            } else {
                feedback.innerHTML = '‚ùå **Quase l√°!** A express√£o √© usada para indicar a situa√ß√£o de **maior cansa√ßo/sono**.';
                feedback.classList.add('text-red-500');
            }
        }
        window.checkMatch = checkMatch; // Expor ao escopo global

        // 5.3 Submit Production Sentence
        async function submitProduction(lessonId, quizType, expression) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`production-input-${lessonId}`);
            const feedback = document.getElementById(`production-feedback-${lessonId}`);
            const sentence = input.value.trim();

            if (userProgress.masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Sua frase parece boa. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (sentence.length < 5) {
                feedback.innerHTML = '‚ö†Ô∏è **Por favor, escreva uma frase completa.**';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            const expressionLower = normalizeString(expression);
            const lowerSentence = normalizeString(sentence);

            let isUsed = lowerSentence.includes(expressionLower) || (expressionLower === 'i am beat' && lowerSentence.includes('beat')) || (expressionLower === "i'm hitting the hay" && lowerSentence.includes('hit the hay'));

            if (isUsed) {
                const ptWords = ['muito', 'o', 'a', 'de', 'para', 'eu', 'voc√™', 'meu', 'minha', 'um', 'uma', 'uns', 'umas', 'e', 'mas', 'ou', 'se', 'n√£o', 'sim', 'com', 'sem', 'em', 'no', 'na', 'nos', 'nas', 'por', 'para', 'de', 'do', 'da', 'dos', 'das', 'entre', 'sobre', 'sob', 'ap√≥s', 'antes', 'at√©', 'desde', 'durante', 'contra', 'perante', 'atr√°s', 'frente', 'dentro', 'fora', 'acima', 'abaixo', 'perto', 'longe', 'aqui', 'ali', 'l√°', 'onde', 'quando', 'como', 'porque', 'portanto', 'entretanto', 'todavia', 'contudo', 'assim', 'tamb√©m', 'ainda', 'j√°', 'sempre', 'nunca', 'quase', 'apenas', 's√≥', 'muito', 'pouco', 'mais', 'menos', 'melhor', 'pior', 'bom', 'boa', 'mal', 'bem', 'grande', 'pequeno', 'novo', 'velho', 'certo', 'errado', 'feliz', 'triste', 'bonito', 'feio', 'r√°pido', 'lento', 'f√°cil', 'dif√≠cil', 'claro', 'escuro', 'quente', 'frio', 'cheio', 'vazio', 'aberto', 'fechado', 'limpo', 'sujo', 'forte', 'fraco', 'alto', 'baixo', 'rico', 'pobre', 'jovem', 'velho']; // Lista mais abrangente de palavras em portugu√™s
                let errorFound = ptWords.some(word => lowerSentence.includes(word));

                let guidance = '';
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    guidance = `üëç **√ìtimo uso!** Sua frase √© natural e usa a express√£o no contexto correto. (+${POINTS_PER_QUIZ} Pontos)`;
                    input.disabled = true; // Desabilita o input ap√≥s o acerto
                    document.getElementById(`production-button-${lessonId}`).disabled = true;
                } else {
                    guidance = 'üëç **√ìtimo uso!** Sua frase √© natural e usa a express√£o no contexto correto.';
                }

                if (errorFound) {
                    guidance += '<br><span class="text-yellow-300">üí° **Pequena Revis√£o:** Encontrei algumas palavras que parecem ser de portugu√™s. Verifique se sua frase √© 100% em ingl√™s.</span>';
                    feedback.classList.add('text-yellow-400');
                    applySuccessFeedback(input.id); // Ainda √© um sucesso, mas com um aviso
                } else {
                    guidance += '<br><span class="text-green-300">‚úÖ **Feedback Gramatical B√°sico:** A estrutura da frase parece correta e a pontua√ß√£o √© boa. Parab√©ns!</span>';
                    feedback.classList.add('text-green-400');
                    applySuccessFeedback(input.id);
                }

                feedback.innerHTML = guidance;

            } else {
                feedback.innerHTML = `‚ùå **Revise sua frase.** A express√£o ("${expression}") n√£o parece ter sido inclu√≠da. Tente novamente!`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.submitProduction = submitProduction; // Expor ao escopo global

        // 5.4 Check Scenario Answer
        async function checkScenarioAnswer(lessonId, quizType, expression, expectedAnswer) {
            const quizId = `${quizType}-${lessonId}`;
            const input = document.getElementById(`scenario-input-${lessonId}`);
            const feedback = document.getElementById(`scenario-feedback-${lessonId}`);
            const userAnswer = normalizeString(input.value);
            const expressionLower = normalizeString(expression);
            const expectedText = expectedAnswer;

            if (userProgress.masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (input.value.length < 10) {
                feedback.innerHTML = '‚ö†Ô∏è Por favor, escreva uma resposta completa √† situa√ß√£o.';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            if (userAnswer.includes(expressionLower) || (expressionLower === 'i am beat' && userAnswer.includes('beat'))) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `üéâ **Resposta Excelente!** Voc√™ aplicou a express√£o corretamente no cen√°rio. Exemplo de resposta: <span class="text-green-300 italic">"${expectedText}"</span>. (+${POINTS_PER_QUIZ} Pontos)`;
                    input.disabled = true; // Desabilita o input ap√≥s o acerto
                    document.getElementById(`scenario-button-${lessonId}`).disabled = true;
                } else {
                    feedback.innerHTML = `üéâ **Resposta Excelente!** Voc√™ aplicou a express√£o corretamente no cen√°rio. Exemplo de resposta: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                }
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
            } else {
                feedback.innerHTML = `‚ùå **Quase l√°.** Sua resposta n√£o cont√©m a express√£o "${expression}". Lembre-se, o objetivo √© us√°-la.`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.checkScenarioAnswer = checkScenarioAnswer; // Expor ao escopo global

        // 5.5 & 5.6 Check Translation Answer
        async function checkTranslationAnswer(lessonId, quizType, challengeNumber, expression, expectedTranslation) {
            const quizId = `${quizType}-${challengeNumber}-${lessonId}`; // quizType agora inclui o challengeNumber
            const input = document.getElementById(`translation-input-${challengeNumber}-${lessonId}`);
            const feedback = document.getElementById(`translation-feedback-${challengeNumber}-${lessonId}`);
            const userAnswer = normalizeString(input.value);
            const expressionLower = normalizeString(expression);
            const expectedText = expectedTranslation;

            if (userProgress.masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Correto. Voc√™ j√° ganhou os ${POINTS_PER_QUIZ} pontos por este exerc√≠cio. Exemplo: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                feedback.classList.add('text-green-400');
                return;
            }

            feedback.className = 'mt-4 text-lg font-semibold';

            if (input.value.length < 10) {
                feedback.innerHTML = '‚ö†Ô∏è Por favor, escreva a tradu√ß√£o completa.';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            if (userAnswer.includes(expressionLower) || (expressionLower === 'i am beat' && userAnswer.includes('beat'))) {
                if (await markQuizComplete(lessonId, quizType, POINTS_PER_QUIZ, true)) {
                    feedback.innerHTML = `üéâ **Tradu√ß√£o Correta!** Voc√™ usou a express√£o no contexto da frase. Uma tradu√ß√£o ideal seria: <span class="text-green-300 italic">"${expectedText}"</span>. (+${POINTS_PER_QUIZ} Pontos)`;
                    input.disabled = true; // Desabilita o input ap√≥s o acerto
                    document.getElementById(`translation-button-${challengeNumber}-${lessonId}`).disabled = true;
                } else {
                    feedback.innerHTML = `üéâ **Tradu√ß√£o Correta!** Voc√™ usou a express√£o no contexto da frase. Uma tradu√ß√£o ideal seria: <span class="text-green-300 italic">"${expectedText}"</span>.`;
                }
                feedback.classList.add('text-green-400');
                applySuccessFeedback(input.id);
            } else {
                feedback.innerHTML = `‚ùå **Tradu√ß√£o Incorreta.** Sua frase em ingl√™s n√£o cont√©m a express√£o "${expression}". Reveja a se√ß√£o de significado!`;
                feedback.classList.add('text-red-500');
                applyErrorFeedback(input.id);
            }
        }
        window.checkTranslationAnswer = checkTranslationAnswer; // Expor ao escopo global

        // 5.7 Daily Challenge Completion
        async function completeChallenge(lessonId) {
            const quizId = `daily-challenge-${lessonId}`;
            const input = document.getElementById(`challenge-input-${lessonId}`);
            const feedback = document.getElementById(`challenge-feedback-${lessonId}`);
            const button = document.getElementById(`complete-challenge-button-${lessonId}`);
            const challengeText = input.value.trim();

            if (userProgress.masteredLessons[quizId]) {
                feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                feedback.classList.add('text-green-400');
                return;
            }

            if (challengeText.length < 20) { // Exige uma resposta mais elaborada
                feedback.innerHTML = '‚ö†Ô∏è Por favor, descreva sua experi√™ncia com mais detalhes (m√≠nimo 20 caracteres).';
                feedback.classList.add('text-yellow-400');
                applyErrorFeedback(input.id);
                return;
            }

            // Simplesmente marca como completo e d√° pontos, pois √© um desafio de auto-relato
            if (await markQuizComplete(lessonId, quizId, POINTS_PER_CHALLENGE, true)) {
                feedback.innerHTML = `üéâ **Miss√£o Conclu√≠da!** Parab√©ns por aplicar a express√£o na vida real! (+${POINTS_PER_CHALLENGE} Pontos)`;
                feedback.classList.add('text-green-400');
                applySuccessFeedback(button.id);
                button.disabled = true;
                button.textContent = 'Miss√£o Conclu√≠da! ‚úÖ';
                input.disabled = true; // Desabilita o input
            } else {
                feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                feedback.classList.add('text-green-400');
            }
        }
        window.completeChallenge = completeChallenge; // Expor ao escopo global

        // Fun√ß√£o para atualizar o estado do bot√£o do desafio di√°rio
        function updateDailyChallengeButtonState(lessonId) {
            const quizId = `daily-challenge-${lessonId}`;
            const button = document.getElementById(`complete-challenge-button-${lessonId}`);
            const feedback = document.getElementById(`challenge-feedback-${lessonId}`);
            const input = document.getElementById(`challenge-input-${lessonId}`);

            if (button) {
                if (userProgress.masteredLessons[quizId]) {
                    button.disabled = true;
                    button.textContent = 'Miss√£o Conclu√≠da! ‚úÖ';
                    if (input) input.disabled = true;
                    feedback.innerHTML = `‚úÖ Voc√™ j√° concluiu esta miss√£o e ganhou os ${POINTS_PER_CHALLENGE} pontos.`;
                    feedback.classList.add('text-green-400');
                } else {
                    button.disabled = false;
                    button.textContent = `Concluir Miss√£o (+${POINTS_PER_CHALLENGE} Pontos)`;
                    if (input) input.disabled = false;
                    feedback.innerHTML = ''; // Limpa feedback se n√£o estiver completo
                }
            }
        }

        // Carrega a li√ß√£o 1 assim que o DOM estiver pronto e o Firebase setup for conclu√≠do
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase(); // Inicia o Firebase, que por sua vez chamar√° loadLesson(activeLessonId)
        });

    </script>
</body>
</html>
